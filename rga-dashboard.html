<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>RGA Dashboard | PharmaT Audit</title>
  <style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #ffffff;
    margin: 0;
    padding: 36px 24px 48px;
    min-height: 100vh;
    color: #1f2933;
  }

  .page-shell {
    max-width: 1200px;
    margin: 0 auto;
  }

  .top-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    background: #ffffff;
    border-radius: 16px;
    padding: 12px 18px;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    margin: 0 auto 24px;
    max-width: 1200px;
  }

  .nav-brand {
    font-weight: 700;
    color: #2d5a27;
    font-size: 18px;
  }

  .nav-links {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .nav-link {
    text-decoration: none;
    color: #475569;
    font-weight: 600;
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid transparent;
    background: #f8fafc;
    transition: all 0.2s ease;
  }

  .nav-link:hover {
    color: #1d4ed8;
    border-color: #cbd5e1;
    background: #eef2ff;
  }

  .nav-link.active {
    color: #ffffff;
    background: #2d5a27;
    border-color: #2d5a27;
  }

    .dashboard {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
      padding: 36px 42px 48px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
      margin-bottom: 32px;
    }

    .header h1 {
      margin: 0;
      font-size: 32px;
      color: #2d5a27;
      font-weight: 700;
    }

    .header p {
      margin: 6px 0 0;
      color: #5f6c7b;
      font-size: 15px;
    }

    .task-admin {
      margin-bottom: 28px;
      padding: 22px 24px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
    }

    .task-admin h2 {
      margin: 0 0 8px;
      font-size: 22px;
      color: #1f2933;
    }

    .task-admin p {
      margin: 0 0 18px;
      color: #5f6c7b;
      font-size: 14px;
    }

    .task-admin form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .task-admin label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: #52606d;
      flex: 1 1 220px;
    }

    .task-admin input,
    .task-admin select,
    .task-admin textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d9e6;
      font-size: 14px;
      background: #ffffff;
      font-family: inherit;
    }

    .task-admin textarea {
      min-height: 70px;
      resize: vertical;
    }

    .task-deadline-fields {
      display: flex;
      gap: 8px;
    }

    .task-deadline-fields input {
      flex: 1;
    }

    .task-admin-actions {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .task-admin button {
      background: #2d5a27;
      color: #ffffff;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .task-admin button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(45, 90, 39, 0.18);
    }

    .task-admin-list {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .task-admin-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
    }

    .task-admin-item h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #1f2933;
    }

    .task-admin-meta {
      font-size: 12px;
      color: #64748b;
    }

    .task-admin-delete {
      background: #dc2626;
      color: #ffffff;
      border: 1px solid #b91c1c;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      height: fit-content;
    }

    .profile-chip {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid #d1d9e6;
      color: #1f2933;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .profile-chip:hover {
      background: #e2efff;
      border-color: #b6d8ff;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(45, 90, 39, 0.15);
    }

    .profile-chip span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #2d5a27;
      color: #ffffff;
      font-weight: 700;
    }

    .pharmacies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    .pharmacy-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 22px 24px 26px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.10);
    }

    .pharmacy-card h2 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #1f2933;
      font-weight: 700;
    }

    .pharmacy-card small {
      display: block;
      color: #64748b;
      margin-bottom: 18px;
      font-size: 13px;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
    }

    .task-item h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #1f2933;
    }

    .task-item p {
      margin: 0;
      color: #52606d;
      font-size: 13px;
    }

    .status-chip {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .status-waiting {
      background: #fff4ce;
      border-color: #fcd34d;
      color: #b45309;
    }

    .status-approved {
      background: #d1fae5;
      border-color: #6ee7b7;
      color: #047857;
    }

    .status-rejected {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #b91c1c;
    }

    .status-not-submitted {
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      color: #475569;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .task-action-btn {
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: #1d4ed8;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .task-action-btn:hover {
      background: #e0ecff;
      transform: translateY(-1px);
    }

    .task-action-btn.approve {
      color: #047857;
      border-color: #6ee7b7;
    }

    .task-action-btn.delete {
      color: #b91c1c;
      border-color: #fca5a5;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 28px 30px;
      max-width: 540px;
      width: 100%;
      box-shadow: 0 25px 55px rgba(15, 23, 42, 0.25);
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 16px;
      border: none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      color: #475569;
    }

    .modal-section {
      margin-top: 18px;
    }

    .modal-section h4 {
      margin: 0 0 10px;
      color: #1f2933;
      font-size: 16px;
    }

    .modal-section ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #52606d;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 12px 24px;
      }

    .top-nav {
      flex-direction: column;
      align-items: flex-start;
    }

      .dashboard {
        padding: 20px 16px 28px;
        border-radius: 12px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .header h1 {
        font-size: 24px;
      }

      .header p {
        font-size: 14px;
      }

      .profile-chip {
        width: 100%;
        justify-content: flex-start;
        padding: 10px 14px;
      }

      .pharmacies-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .pharmacy-card {
        padding: 18px 20px;
      }

      .pharmacy-card h2 {
        font-size: 18px;
      }

      .pharmacy-card small {
        font-size: 12px;
      }

      .task-item {
        flex-direction: column;
        gap: 12px;
        padding: 12px 14px;
      }

      .task-item h3 {
        font-size: 15px;
      }

      .task-item p {
        font-size: 12px;
      }

      .task-status {
        width: 100%;
        align-items: flex-start;
      }

      .status-chip {
        font-size: 11px;
        padding: 8px 10px;
      }

      .task-actions {
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        width: 100%;
      }

      .task-action-btn {
        flex: 1;
        min-width: 80px;
        padding: 10px 12px;
        font-size: 12px;
        min-height: 44px;
      }

      .modal-content {
        max-width: calc(100% - 32px);
        padding: 24px 20px;
        margin: 16px;
      }

      .modal-close {
        top: 8px;
        right: 12px;
        font-size: 24px;
        padding: 4px 8px;
        min-width: 44px;
        min-height: 44px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px 8px 20px;
      }

      .dashboard {
        padding: 16px 12px 24px;
      }

      .header h1 {
        font-size: 22px;
      }

      .pharmacy-card {
        padding: 16px;
      }

      .task-item {
        padding: 12px;
      }

      .modal-content {
        padding: 20px 16px;
        margin: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell" style="display:none;">
    <nav class="top-nav" aria-label="Primary">
      <div class="nav-brand">PharmaT Audit</div>
      <div class="nav-links">
        <a href="rga-dashboard.html" class="nav-link active">Dashboard</a>
        <a href="calendar.html" class="nav-link">Calendar</a>
      </div>
    </nav>
    <div class="dashboard">
    <div class="header">
      <div>
        <h1 id="dashboardTitle">RGA Dashboard</h1>
        <p id="dashboardSubtitle"></p>
      </div>
      <a href="profile.html" class="profile-chip" id="profileLink">
        <span id="profileInitials">R</span>
        <div>
          <div id="chipName" style="font-weight:600; color:#1f2933;">—</div>
          <small id="chipEmail" style="color:#52606d;">—</small>
        </div>
      </a>
    </div>

    <section class="task-admin" id="taskAdminSection">
      <h2>Task management</h2>
      <p></p>
      <form id="taskAdminForm">
        <label>
          Title
          <input type="text" id="taskTitle" placeholder="e.g. Send photo of shelf" required>
        </label>
        <label>
          Description
          <textarea id="taskDescription" placeholder="Short instruction for employees"></textarea>
        </label>
        <label>
          Frequency
          <select id="taskFrequency">
            <option value="daily">Daily</option>
            <option value="one_time">One day</option>
          </select>
        </label>
        <label id="taskDateField">
          Date
          <input type="date" id="taskDate">
        </label>
        <label class="task-deadline">
          Deadline
          <div class="task-deadline-fields">
            <input type="date" id="taskDeadlineDate">
            <input type="time" id="taskDeadline">
          </div>
        </label>
        <div class="task-admin-actions">
          <button type="submit">Add task</button>
        </div>
      </form>
      <div class="task-admin-list" id="taskAdminList"></div>
    </section>

    <section>
      <h2 style="margin:0 0 18px; font-size:24px; color:#1f2933;">My pharmacies</h2>
      <div id="pharmaciesGrid" class="pharmacies-grid"></div>
    </section>
    </div>
  </div>

  <div id="pharmacyModal" class="modal-backdrop">
    <div class="modal-content">
      <button type="button" class="modal-close" aria-label="Close">&times;</button>
      <h3 id="modalTitle" style="margin:0 0 6px; color:#1f2933;"></h3>
      <p id="modalAddress" style="margin:0; color:#5f6c7b;"></p>
      <div class="modal-section">
        <h4>Employees</h4>
        <ul id="modalEmployees"></ul>
      </div>
      <div class="modal-section">
        <h4>Task statuses</h4>
        <ul id="modalTasks"></ul>
      </div>
    </div>
  </div>

  <script>
    async function init() {
      const DEFAULT_TASKS = [
        { key: 'window', title: 'Send photo of a window', description: 'Confirm storefront visibility and merchandising.' },
        { key: 'trash', title: 'Send photo of trash cans', description: 'Ensure the waste disposal area is clean and labelled.' },
        { key: 'outfit', title: 'Send photo of an outfit', description: 'Confirm staff uniform compliance.' }
      ];

      const STATUS_LABELS = {
        not_submitted: 'Not submitted',
        waiting: 'Waiting for approval',
        approved: 'Approved',
        rejected: 'Not approved'
      };

      const STATUS_CLASSES = {
        not_submitted: 'status-not-submitted',
        waiting: 'status-waiting',
        approved: 'status-approved',
        rejected: 'status-rejected'
      };

      const grid = document.getElementById('pharmaciesGrid');
      const chipName = document.getElementById('chipName');
      const chipEmail = document.getElementById('chipEmail');
      const profileInitials = document.getElementById('profileInitials');
      const dashboardTitle = document.getElementById('dashboardTitle');
      const dashboardSubtitle = document.getElementById('dashboardSubtitle');
      const profileLinkEl = document.getElementById('profileLink');
      const modalBackdrop = document.getElementById('pharmacyModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalAddress = document.getElementById('modalAddress');
      const modalEmployees = document.getElementById('modalEmployees');
      const modalTasks = document.getElementById('modalTasks');
      const modalClose = document.querySelector('.modal-close');
      const taskAdminForm = document.getElementById('taskAdminForm');
      const taskAdminList = document.getElementById('taskAdminList');
      const taskTitleInput = document.getElementById('taskTitle');
      const taskDescriptionInput = document.getElementById('taskDescription');
      const taskFrequencySelect = document.getElementById('taskFrequency');
      const taskDateInput = document.getElementById('taskDate');
      const taskDateField = document.getElementById('taskDateField');
      const taskDeadlineDateInput = document.getElementById('taskDeadlineDate');
      const taskDeadlineInput = document.getElementById('taskDeadline');

      let taskDefinitions = DEFAULT_TASKS;
      let currentPharmacies = [];
      const submissionState = {};
      let lastDateKey = new Date().toISOString().slice(0, 10);


      function getTodayKey() {
        return new Date().toISOString().slice(0, 10);
      }

      function isSameDay(dateValue) {
        if (!dateValue) return false;
        const date = new Date(dateValue);
        if (isNaN(date.getTime())) return false;
        return date.toISOString().slice(0, 10) === getTodayKey();
      }

      function transliterate(value) {
        if (!value) return '';
        const map = {
          'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'e','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m',
          'н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'kh','ц':'ts','ч':'ch','ш':'sh','щ':'shch',
          'ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya',
          'А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'E','Ж':'Zh','З':'Z','И':'I','Й':'Y','К':'K','Л':'L','М':'M',
          'Н':'N','О':'O','П':'P','Р':'R','С':'S','Т':'T','У':'U','Ф':'F','Х':'Kh','Ц':'Ts','Ч':'Ch','Ш':'Sh','Щ':'Shch',
          'Ъ':'','Ы':'Y','Ь':'','Э':'E','Ю':'Yu','Я':'Ya'
        };
        let result = '';
        for (let i = 0; i < value.length; i++) {
          const char = value[i];
          result += (map[char] !== undefined) ? map[char] : char;
        }
        return result.replace(/\s+/g, ' ').trim();
      }

      function createEmptyEntry() {
        return {
          state: 'not_submitted',
          submitted: false,
          fileName: '',
          fileUrl: '',
          employeeEmail: '',
          reviewerEmail: '',
          reviewNote: '',
          updatedAt: null,
          reviewedAt: null
        };
      }

      function createEmptyTaskMap() {
        const map = {};
        const tasks = getActiveTaskDefinitions();
        for (let i = 0; i < tasks.length; i++) {
          map[tasks[i].key] = createEmptyEntry();
        }
        return map;
      }

      function getActiveTaskDefinitions(pharmacyIndex) {
        const today = getTodayKey();
        const result = [];
        for (let i = 0; i < taskDefinitions.length; i++) {
          const task = taskDefinitions[i];
          if (!task) continue;
          if (task.frequency === 'one_time' && task.active_date !== today) continue;
          if (pharmacyIndex !== undefined && pharmacyIndex !== null
              && Array.isArray(task.pharmacy_indexes) && task.pharmacy_indexes.length > 0) {
            if (!task.pharmacy_indexes.map(String).includes(String(pharmacyIndex))) continue;
          }
          result.push(task);
        }
        return result;
      }

      function normalizeEntry(entry) {
        if (!entry) return createEmptyEntry();

        if (typeof entry !== 'object') {
          const result = createEmptyEntry();
          result.state = entry;
          result.submitted = (entry !== 'not_submitted');
          return result;
        }

        const normalized = createEmptyEntry();
        normalized.state = entry.state || 'not_submitted';
        normalized.submitted = entry.submitted || (normalized.state !== 'not_submitted');
        normalized.fileName = entry.fileName || entry.filename || '';
        normalized.fileUrl = entry.fileUrl || '';
        normalized.employeeEmail = entry.employeeEmail || entry.employee_email || '';
        normalized.reviewerEmail = entry.reviewerEmail || entry.reviewer_email || '';
        normalized.reviewNote = entry.reviewNote || entry.review_note || '';
        normalized.updatedAt = entry.updatedAt || entry.updated_at || null;
        normalized.reviewedAt = entry.reviewedAt || entry.reviewed_at || null;

        if (normalized.updatedAt && !isSameDay(normalized.updatedAt)) {
          return createEmptyEntry();
        }

        if (normalized.state === 'submitted') {
          normalized.state = 'waiting';
        }

        return normalized;
      }

      function ensurePharmacyState(indexKey) {
        if (!submissionState[indexKey]) {
          submissionState[indexKey] = createEmptyTaskMap();
        }
        return submissionState[indexKey];
      }

      function getTaskStatusFor(indexKey) {
        const store = ensurePharmacyState(indexKey);
        const keys = Object.keys(store);
        for (let i = 0; i < keys.length; i++) {
          store[keys[i]] = normalizeEntry(store[keys[i]]);
        }
        return store;
      }

      function getTaskDueDate(task) {
        if (!task || !task.due_time) return null;
        const baseDate = task.due_date
          || (task.frequency === 'one_time' && task.active_date ? task.active_date : getTodayKey());
        return new Date(baseDate + 'T' + task.due_time);
      }

      function isLateSubmission(entry, task) {
        if (!entry || !entry.updatedAt || !task || !task.due_time) return false;
        const dueDate = getTaskDueDate(task);
        if (!dueDate || isNaN(dueDate.getTime())) return false;
        const submittedAt = new Date(entry.updatedAt);
        if (isNaN(submittedAt.getTime())) return false;
        return submittedAt.getTime() > dueDate.getTime();
      }

      function formatStatusNote(status, entry) {
        if (status === 'waiting') {
          return entry.employeeEmail
            ? 'Submitted by ' + entry.employeeEmail + ' • Awaiting your review.'
            : 'Submitted by employee • Awaiting your review.';
        }
        if (status === 'approved') {
          if (entry.reviewNote) return 'Approved • ' + entry.reviewNote;
          return entry.reviewerEmail ? 'Approved by ' + entry.reviewerEmail + '.' : 'Approved.';
        }
        if (status === 'rejected') {
          if (entry.reviewNote) return 'Rejected • ' + entry.reviewNote;
          return entry.reviewerEmail ? 'Rejected by ' + entry.reviewerEmail + '.' : 'Marked for resubmission.';
        }
        return 'No submission yet.';
      }


      async function fetchSession() {
        try {
          const response = await fetch('/api/session');
          if (!response.ok) return null;
          const data = await response.json();
          return (data && data.session) ? data.session : null;
        } catch (error) {
          return null;
        }
      }

      async function fetchProfile() {
        try {
          const response = await fetch('/api/profile');
          if (!response.ok) return null;
          const data = await response.json();
          return (data && data.profile) ? data.profile : null;
        } catch (error) {
          return null;
        }
      }

      async function fetchSubmissions(query) {
        let url = '/api/get-submissions';
        const params = [];
        if (query.pharmacies) {
          params.push('pharmacies=' + (Array.isArray(query.pharmacies) ? query.pharmacies.join(',') : query.pharmacies));
        }
        if (query.role) {
          params.push('role=' + query.role);
        }
        if (params.length) url += '?' + params.join('&');

        const response = await fetch(url);
        if (!response.ok) throw new Error('Unable to fetch submissions');
        const data = await response.json();
        if (!data || !data.ok) throw new Error('Unexpected response');
        return data.submissions || [];
      }

      async function fetchTaskDefinitions() {
        try {
          const response = await fetch('/api/task-definitions');
          if (!response.ok) return DEFAULT_TASKS;
          const data = await response.json();
          return (data && Array.isArray(data.tasks)) ? data.tasks : DEFAULT_TASKS;
        } catch (error) {
          return DEFAULT_TASKS;
        }
      }

      async function addTaskDefinition(payload) {
        const response = await fetch('/api/task-definitions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (!response.ok || !data || !data.ok) {
          throw new Error((data && data.error) || 'Unable to add task');
        }
        return data.task;
      }

      async function deleteTaskDefinition(taskId) {
        const response = await fetch('/api/task-definitions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'delete', id: taskId })
        });
        const data = await response.json();
        if (!response.ok || !data || !data.ok) {
          throw new Error((data && data.error) || 'Unable to delete task');
        }
        return data.task;
      }


      function mergeSubmissions(submissions) {
        const existingTasks = new Set();
        const pharmaciesWithData = new Set();

        for (let i = 0; i < submissions.length; i++) {
          const item = submissions[i];
          if (!item || !item.task_key) continue;

          const indexKey = String(item.pharmacy_index);
          existingTasks.add(indexKey + ':' + item.task_key);
          pharmaciesWithData.add(indexKey);

          const store = ensurePharmacyState(indexKey);
          const existing = store[item.task_key];
          const existingTime = (existing && existing.updatedAt) ? new Date(existing.updatedAt).getTime() : 0;
          const incomingTime = item.updated_at ? new Date(item.updated_at).getTime() : 0;

          if (!existingTime || incomingTime >= existingTime) {
            const newEntry = createEmptyEntry();
            newEntry.state = item.status || 'waiting';
            newEntry.submitted = item.status ? (item.status !== 'not_submitted') : true;
            newEntry.fileName = item.file_name || '';
            newEntry.fileUrl = item.file_url || '';
            newEntry.employeeEmail = item.employee_email || '';
            newEntry.reviewerEmail = item.reviewer_email || '';
            newEntry.reviewNote = item.review_note || '';
            newEntry.updatedAt = item.updated_at || null;
            newEntry.reviewedAt = item.reviewed_at || null;
            store[item.task_key] = newEntry;
          }
        }

        pharmaciesWithData.forEach(function(indexKey) {
          const store = ensurePharmacyState(indexKey);
          const activeTasks = getActiveTaskDefinitions();
          for (let i = 0; i < activeTasks.length; i++) {
            const taskId = indexKey + ':' + activeTasks[i].key;
            const currentEntry = store[activeTasks[i].key];
            if (!existingTasks.has(taskId) && currentEntry && currentEntry.state !== 'not_submitted') {
              store[activeTasks[i].key] = createEmptyEntry();
            }
          }
        });
      }

      async function loadSubmissions(pharmacies) {
        const indexes = [];
        for (let i = 0; i < pharmacies.length; i++) {
          if (pharmacies[i] && pharmacies[i].index !== undefined) {
            indexes.push(pharmacies[i].index);
          }
        }
        if (!indexes.length) return;
        try {
          const submissions = await fetchSubmissions({ pharmacies: indexes, role: 'rga' });
          mergeSubmissions(submissions);
        } catch (error) {
          console.warn('Unable to load submissions', error);
        }
      }


      function syncTaskDateField() {
        if (!taskFrequencySelect || !taskDateField) return;
        const isOneTime = (taskFrequencySelect.value === 'one_time');
        taskDateField.style.display = isOneTime ? 'flex' : 'none';
        if (!isOneTime && taskDateInput) taskDateInput.value = '';
      }

      function renderTaskAdminList(definitions) {
        if (!taskAdminList) return;
        if (!definitions.length) {
          taskAdminList.innerHTML = '<p style="color:#64748b; margin:0;">No tasks created yet.</p>';
          return;
        }
        let html = '';
        for (let i = 0; i < definitions.length; i++) {
          const task = definitions[i];
          const canDelete = (task.id !== undefined && task.id !== null);
          const frequencyLabel = (task.frequency === 'one_time')
            ? 'One day • ' + (task.active_date || 'date not set')
            : 'Daily';
          const deadlineLabel = task.due_time
            ? 'Deadline: ' + (task.due_date || 'today') + ' ' + task.due_time
            : 'No deadline';
          const scopeLabel = (Array.isArray(task.pharmacy_indexes) && task.pharmacy_indexes.length)
            ? 'Pharmacies: ' + task.pharmacy_indexes.join(', ')
            : 'All pharmacies';

          html += '<div class="task-admin-item" data-task-id="' + (task.id || '') + '">';
          html += '<div>';
          html += '<h3>' + task.title + '</h3>';
          html += '<div class="task-admin-meta">' + frequencyLabel + '</div>';
          html += '<div class="task-admin-meta">' + deadlineLabel + '</div>';
          html += '<div class="task-admin-meta">' + scopeLabel + '</div>';
          html += '<div class="task-admin-meta">' + (task.description || '') + '</div>';
          html += '</div>';
          if (canDelete) {
            html += '<button type="button" class="task-admin-delete" data-task-id="' + task.id + '">Delete</button>';
          }
          html += '</div>';
        }
        taskAdminList.innerHTML = html;
      }

      function renderPharmacyCard(pharmacy) {
        const indexKey = String(pharmacy.index);
        const taskStatuses = getTaskStatusFor(indexKey);

        const metaParts = [];
        if (pharmacy.region) metaParts.push(transliterate(pharmacy.region));
        if (pharmacy.address) metaParts.push(transliterate(pharmacy.address));
        if (pharmacy.phone) metaParts.push('Tel.: ' + pharmacy.phone);
        const meta = metaParts.join(' • ');

        let taskItems = '';
        const activeTasks = getActiveTaskDefinitions(indexKey);
        for (let i = 0; i < activeTasks.length; i++) {
          const task = activeTasks[i];
          const entry = normalizeEntry(taskStatuses[task.key]);

          let status = entry.state || 'not_submitted';
          if (!entry.fileUrl && status !== 'not_submitted') {
            status = 'not_submitted';
            const store = ensurePharmacyState(indexKey);
            store[task.key] = createEmptyEntry();
          }

          const statusClass = STATUS_CLASSES[status] || STATUS_CLASSES.waiting;
          const statusLabel = STATUS_LABELS[status] || STATUS_LABELS.waiting;
          const note = formatStatusNote(status, entry);
          const isLate = isLateSubmission(entry, task);

          let actionsHtml = '';
          const buttons = [];
          if (entry.fileUrl) {
            buttons.push('<button type="button" class="task-action-btn open" data-action="open" data-task="' + task.key + '" data-pharmacy-index="' + indexKey + '">Open</button>');
          }
          if (status === 'waiting') {
            buttons.push('<button type="button" class="task-action-btn approve" data-action="approve" data-task="' + task.key + '" data-pharmacy-index="' + indexKey + '">Approve</button>');
            buttons.push('<button type="button" class="task-action-btn delete" data-action="reject" data-task="' + task.key + '" data-pharmacy-index="' + indexKey + '">Reject</button>');
          }
          if (buttons.length) {
            actionsHtml = '<div class="task-actions">' + buttons.join('') + '</div>';
          }

          let noteColor = '#64748b';
          let noteWeight = '400';
          if (isLate) { noteColor = '#b91c1c'; noteWeight = '600'; }
          else if (status === 'waiting') { noteColor = '#b45309'; noteWeight = '600'; }

          taskItems += '<div class="task-item" data-task="' + task.key + '">';
          taskItems += '<div><h3>' + task.title + '</h3><p>' + task.description + '</p></div>';
          taskItems += '<div class="task-status" style="align-items:flex-end;"><div>';
          taskItems += '<div class="status-chip ' + statusClass + '" data-status-label data-task="' + task.key + '" data-pharmacy-index="' + indexKey + '" data-state="' + status + '" data-filename="' + (entry.fileName || '') + '" data-fileurl="' + (entry.fileUrl || '') + '">' + statusLabel + '</div>';
          taskItems += '<p style="margin:6px 0 0; font-size:12px; color:' + noteColor + '; font-weight:' + noteWeight + ';">' + note + (isLate ? ' • Late' : '') + '</p>';
          taskItems += '</div>' + actionsHtml + '</div></div>';
        }

        return '<article class="pharmacy-card" data-index="' + indexKey + '">'
          + '<h2>' + transliterate(pharmacy.address || '') + '</h2>'
          + '<small>' + meta + '</small>'
          + '<div class="task-list">' + taskItems + '</div>'
          + '</article>';
      }

      function renderPharmacies() {
        if (!grid) return;
        let html = '';
        for (let i = 0; i < currentPharmacies.length; i++) {
          html += renderPharmacyCard(currentPharmacies[i]);
        }
        grid.innerHTML = html;
      }

      function openPharmacyModal(pharmacy) {
        if (!modalBackdrop) return;
        modalBackdrop.classList.add('active');
        modalTitle.textContent = transliterate(pharmacy.address || 'Pharmacy');

        const parts = [];
        if (pharmacy.region) parts.push(transliterate(pharmacy.region));
        if (pharmacy.phone) parts.push(pharmacy.phone);
        if (pharmacy.hours) parts.push(pharmacy.hours);
        modalAddress.textContent = parts.join(' • ');

        const taskStatuses = getTaskStatusFor(String(pharmacy.index));
        const employeeEmails = new Set();
        const statusKeys = Object.keys(taskStatuses);
        for (let i = 0; i < statusKeys.length; i++) {
          const entry = normalizeEntry(taskStatuses[statusKeys[i]]);
          if (entry.employeeEmail) employeeEmails.add(entry.employeeEmail);
        }

        if (employeeEmails.size === 0) {
          modalEmployees.innerHTML = '<li>No employees assigned yet.</li>';
        } else {
          let employeeHtml = '';
          employeeEmails.forEach(function(em) {
            employeeHtml += '<li>' + em + '</li>';
          });
          modalEmployees.innerHTML = employeeHtml;
        }

        const activeTasks = getActiveTaskDefinitions(String(pharmacy.index));
        let tasksHtml = '';
        for (let i = 0; i < activeTasks.length; i++) {
          const task = activeTasks[i];
          const entry = normalizeEntry(taskStatuses[task.key]);
          const status = entry.state || 'not_submitted';
          const label = STATUS_LABELS[status] || STATUS_LABELS.waiting;
          tasksHtml += '<li><strong>' + task.title + ':</strong> ' + label + '</li>';
        }
        modalTasks.innerHTML = tasksHtml;
      }

      function closeModal() {
        if (modalBackdrop) modalBackdrop.classList.remove('active');
      }

      async function refreshForNewDay() {
        const todayKey = getTodayKey();
        if (todayKey === lastDateKey) return false;
        lastDateKey = todayKey;
        taskDefinitions = await fetchTaskDefinitions();
        renderTaskAdminList(taskDefinitions);
        renderPharmacies();
        return true;
      }


      const session = await fetchSession();
      if (!session) {
        window.location.href = 'register.html';
        return;
      }
      if ((session.role || '').toLowerCase() !== 'rga') {
        window.location.href = 'employee.html';
        return;
      }

      document.querySelector('.page-shell').style.display = '';

      const profileData = await fetchProfile();
      if (!profileData) {
        grid.innerHTML = '<p style="color:#64748b;">No profile data found. Please complete your profile first.</p>';
        if (profileLinkEl) profileLinkEl.href = 'profile.html';
        return;
      }

      const firstName = profileData.first_name || '';
      const lastName = profileData.last_name || '';
      const email = profileData.email || session.email || '';
      const pharmacies = Array.isArray(profileData.pharmacies) ? profileData.pharmacies : [];

      taskDefinitions = await fetchTaskDefinitions();
      renderTaskAdminList(taskDefinitions);
      syncTaskDateField();

      if (taskFrequencySelect) {
        taskFrequencySelect.addEventListener('change', syncTaskDateField);
      }

      if (taskAdminForm) {
        taskAdminForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          const title = taskTitleInput.value.trim();
          const description = taskDescriptionInput ? taskDescriptionInput.value.trim() : '';
          const frequency = taskFrequencySelect ? taskFrequencySelect.value : 'daily';
          const activeDate = (frequency === 'one_time' && taskDateInput) ? taskDateInput.value : '';
          const dueTime = taskDeadlineInput ? taskDeadlineInput.value : '';
          const dueDate = taskDeadlineDateInput ? taskDeadlineDateInput.value : '';

          if (!title) {
            alert('Please enter a task title.');
            return;
          }
          if (frequency === 'one_time' && !activeDate) {
            alert('Please select a date for the one-time task.');
            return;
          }

          try {
            const newTask = await addTaskDefinition({
              title: title,
              description: description,
              frequency: frequency,
              activeDate: activeDate,
              dueTime: dueTime,
              dueDate: dueDate
            });
            taskDefinitions.push(newTask);
            renderTaskAdminList(taskDefinitions);
            taskTitleInput.value = '';
            if (taskDescriptionInput) taskDescriptionInput.value = '';
            if (taskDateInput) taskDateInput.value = '';
            if (taskDeadlineInput) taskDeadlineInput.value = '';
            if (taskDeadlineDateInput) taskDeadlineDateInput.value = '';
            if (taskFrequencySelect) taskFrequencySelect.value = 'daily';
            syncTaskDateField();
            renderPharmacies();
          } catch (error) {
            alert(error.message || 'Unable to add task.');
          }
        });
      }

      if (taskAdminList) {
        taskAdminList.addEventListener('click', async function(event) {
          const deleteBtn = event.target.closest('.task-admin-delete');
          if (!deleteBtn) return;
          const taskId = deleteBtn.dataset.taskId;
          if (!taskId) return;
          if (!confirm('Delete this task?')) return;
          try {
            await deleteTaskDefinition(taskId);
            taskDefinitions = taskDefinitions.filter(function(task) {
              return String(task.id) !== String(taskId);
            });
            renderTaskAdminList(taskDefinitions);
            renderPharmacies();
          } catch (error) {
            alert(error.message || 'Unable to delete task.');
          }
        });
      }

      chipName.textContent = (firstName + ' ' + lastName).trim() || '—';
      chipEmail.textContent = email;
      profileInitials.textContent = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase() || 'R';
      if (profileLinkEl) profileLinkEl.href = 'profile.html';

      if (!pharmacies.length) {
        grid.innerHTML = '<p style="color:#64748b;">No pharmacies assigned yet.</p>';
        return;
      }

      const namePrefix = (firstName || lastName) ? (firstName + ' ' + lastName).trim() + "'s" : 'RGA';
      dashboardTitle.textContent = namePrefix + ' Dashboard';

      currentPharmacies = pharmacies;
      renderPharmacies();
      await loadSubmissions(currentPharmacies);
      renderPharmacies();


      grid.addEventListener('click', async function(event) {
        const chip = event.target.closest('.status-chip');
        if (chip) {
          const state = chip.dataset.state;
          if (state !== 'waiting' && state !== 'approved' && state !== 'rejected') {
            alert('No submission available to review yet.');
            return;
          }
          const taskKey = chip.dataset.task;
          const pharmacyIndex = chip.dataset.pharmacyIndex;
          const store = ensurePharmacyState(pharmacyIndex);
          const entry = normalizeEntry(store[taskKey]);
          if (entry.fileUrl) {
            window.open(entry.fileUrl, '_blank');
          } else {
            alert('Employee uploaded: ' + (entry.fileName || 'Submitted file'));
          }
          return;
        }

        const actionBtn = event.target.closest('.task-action-btn');
        if (actionBtn) {
          const action = actionBtn.dataset.action;
          const taskKey = actionBtn.dataset.task;
          const pharmacyIndex = actionBtn.dataset.pharmacyIndex;
          const store = ensurePharmacyState(pharmacyIndex);
          const entry = normalizeEntry(store[taskKey]);

          if (action === 'open') {
            if (entry.fileUrl) {
              window.open(entry.fileUrl, '_blank');
            } else {
              alert('Employee uploaded: ' + (entry.fileName || 'Submitted file'));
            }
            return;
          }

          if (action === 'approve' || action === 'reject') {
            if (!entry.employeeEmail) {
              alert('Unable to locate the employee who submitted this task.');
              return;
            }
            const nextState = (action === 'approve') ? 'approved' : 'rejected';
            const reviewNote = prompt('Add a note for the employee (optional):', '') || '';
            try {
              const response = await fetch('/api/update-submission-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  employeeEmail: entry.employeeEmail,
                  pharmacyIndex: Number(pharmacyIndex),
                  taskKey: taskKey,
                  status: nextState,
                  reviewerEmail: email || '',
                  reviewNote: reviewNote
                })
              });
              const data = await response.json();
              if (!response.ok || !data || !data.ok) {
                throw new Error((data && data.error) || 'Failed to update status');
              }
              if (data.submission) {
                mergeSubmissions([data.submission]);
              } else {
                const updated = createEmptyEntry();
                updated.state = nextState;
                updated.submitted = true;
                updated.fileName = entry.fileName;
                updated.fileUrl = entry.fileUrl;
                updated.employeeEmail = entry.employeeEmail;
                updated.reviewerEmail = email || '';
                updated.reviewedAt = new Date().toISOString();
                updated.updatedAt = new Date().toISOString();
                store[taskKey] = updated;
              }
              renderPharmacies();
            } catch (error) {
              console.error('Unable to update submission status', error);
              const parentTask = actionBtn.closest('.task-item');
              if (parentTask) {
                const statusNote = parentTask.querySelector('.task-status p');
                if (statusNote) {
                  statusNote.textContent = 'Unable to update status. Please try again later.';
                  statusNote.style.color = '#b91c1c';
                  statusNote.style.fontWeight = '600';
                }
              }
            }
            return;
          }
        }

        const card = event.target.closest('.pharmacy-card');
        const isActionArea = event.target.closest('.task-actions');
        if (card && !isActionArea) {
          const indexKey = card.dataset.index;
          const pharmacy = currentPharmacies.find(function(item) {
            return String(item.index) === indexKey;
          });
          if (pharmacy) openPharmacyModal(pharmacy);
        }
      });

      if (modalBackdrop) {
        modalBackdrop.addEventListener('click', function(event) {
          if (event.target === modalBackdrop) closeModal();
        });
      }
      if (modalClose) {
        modalClose.addEventListener('click', closeModal);
      }

      setInterval(async function() {
        if (!currentPharmacies.length) return;
        try {
          await refreshForNewDay();
          await loadSubmissions(currentPharmacies);
          renderPharmacies();
        } catch (err) {
          console.warn('Periodic refresh failed', err);
        }
      }, 30000);
    }

    init();
  </script>
  <script src="cookie-consent.js"></script>
</body>
</html>
