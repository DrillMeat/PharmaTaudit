<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>RGA Dashboard | PharmaT Audit</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #5c6ac4 0%, #9aa5ff 100%);
      margin: 0;
      padding: 36px 24px 48px;
      min-height: 100vh;
      color: #1f2933;
    }

    .dashboard {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
      padding: 36px 42px 48px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
      margin-bottom: 32px;
    }

    .header h1 {
      margin: 0;
      font-size: 32px;
      color: #2d5a27;
      font-weight: 700;
    }

    .header p {
      margin: 6px 0 0;
      color: #5f6c7b;
      font-size: 15px;
    }

    .profile-chip {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid #d1d9e6;
      color: #1f2933;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .profile-chip:hover {
      background: #e2efff;
      border-color: #b6d8ff;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(45, 90, 39, 0.15);
    }

    .profile-chip span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #2d5a27;
      color: #ffffff;
      font-weight: 700;
    }

    .map-section {
      margin-bottom: 32px;
    }

    .map-section h2 {
      margin: 0 0 12px;
      font-size: 24px;
      color: #1f2933;
    }

    #pharmaciesMap {
      width: 100%;
      height: 420px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 40px;
      border: 1px solid #dbe3f1;
      box-shadow: inset 0 0 0 1px rgba(209, 217, 230, 0.4);
    }

    .pharmacies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    .pharmacy-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 22px 24px 26px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.10);
    }

    .pharmacy-card h2 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #1f2933;
      font-weight: 700;
    }

    .pharmacy-card small {
      display: block;
      color: #64748b;
      margin-bottom: 18px;
      font-size: 13px;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
    }

    .task-item h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #1f2933;
    }

    .task-item p {
      margin: 0;
      color: #52606d;
      font-size: 13px;
    }

    .status-chip {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .status-waiting {
      background: #fff4ce;
      border-color: #fcd34d;
      color: #b45309;
    }

    .status-approved {
      background: #d1fae5;
      border-color: #6ee7b7;
      color: #047857;
    }

    .status-rejected {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #b91c1c;
    }

    .status-not-submitted {
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      color: #475569;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .task-action-btn {
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: #1d4ed8;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .task-action-btn:hover {
      background: #e0ecff;
      transform: translateY(-1px);
    }

    .task-action-btn.approve {
      color: #047857;
      border-color: #6ee7b7;
    }

    .task-action-btn.delete {
      color: #b91c1c;
      border-color: #fca5a5;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .task-action-btn {
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: #1d4ed8;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .task-action-btn:hover {
      background: #e0ecff;
      transform: translateY(-1px);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 28px 30px;
      max-width: 540px;
      width: 100%;
      box-shadow: 0 25px 55px rgba(15, 23, 42, 0.25);
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 16px;
      border: none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      color: #475569;
    }

    .modal-section {
      margin-top: 18px;
    }

    .modal-section h4 {
      margin: 0 0 10px;
      color: #1f2933;
      font-size: 16px;
    }

    .modal-section ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #52606d;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 12px 24px;
      }

      .dashboard {
        padding: 20px 16px 28px;
        border-radius: 12px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .header h1 {
        font-size: 24px;
      }

      .header p {
        font-size: 14px;
      }

      .profile-chip {
        width: 100%;
        justify-content: flex-start;
        padding: 10px 14px;
      }

      .pharmacies-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .pharmacy-card {
        padding: 18px 20px;
      }

      .pharmacy-card h2 {
        font-size: 18px;
      }

      .pharmacy-card small {
        font-size: 12px;
      }

      .task-item {
        flex-direction: column;
        gap: 12px;
        padding: 12px 14px;
      }

      .task-item h3 {
        font-size: 15px;
      }

      .task-item p {
        font-size: 12px;
      }

      .task-status {
        width: 100%;
        align-items: flex-start;
      }

      .status-chip {
        font-size: 11px;
        padding: 8px 10px;
      }

      .task-actions {
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        width: 100%;
      }

      .task-action-btn {
        flex: 1;
        min-width: 80px;
        padding: 10px 12px;
        font-size: 12px;
        min-height: 44px;
      }

      #pharmaciesMap {
        height: 300px;
        margin-bottom: 24px;
      }

      .modal-content {
        max-width: calc(100% - 32px);
        padding: 24px 20px;
        margin: 16px;
      }

      .modal-close {
        top: 8px;
        right: 12px;
        font-size: 24px;
        padding: 4px 8px;
        min-width: 44px;
        min-height: 44px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px 8px 20px;
      }

      .dashboard {
        padding: 16px 12px 24px;
      }

      .header h1 {
        font-size: 22px;
      }

      .pharmacy-card {
        padding: 16px;
      }

      .task-item {
        padding: 12px;
      }

      #pharmaciesMap {
        height: 250px;
      }

      .modal-content {
        padding: 20px 16px;
        margin: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <div>
        <h1 id="dashboardTitle">RGA Dashboard</h1>
        <p id="dashboardSubtitle">Review submission status for each pharmacy under your supervision.</p>
      </div>
      <a href="profile.html" class="profile-chip" id="profileLink">
        <span id="profileInitials">R</span>
        <div>
          <div id="chipName" style="font-weight:600; color:#1f2933;">—</div>
          <small id="chipEmail" style="color:#52606d;">—</small>
        </div>
      </a>
    </div>

    <section>
      <h2 style="margin:0 0 18px; font-size:24px; color:#1f2933;">My pharmacies</h2>
      <div id="mapWrapper" class="map-section" style="display:none;">
        <h2>Map</h2>
        <div id="pharmaciesMap"></div>
      </div>
      <div id="pharmaciesGrid" class="pharmacies-grid"></div>
    </section>
  </div>

  <div id="pharmacyModal" class="modal-backdrop">
    <div class="modal-content">
      <button type="button" class="modal-close" aria-label="Close">&times;</button>
      <h3 id="modalTitle" style="margin:0 0 6px; color:#1f2933;"></h3>
      <p id="modalAddress" style="margin:0; color:#5f6c7b;"></p>
      <div class="modal-section">
        <h4>Employees</h4>
        <ul id="modalEmployees"></ul>
      </div>
      <div class="modal-section">
        <h4>Task statuses</h4>
        <ul id="modalTasks"></ul>
      </div>
    </div>
  </div>

  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <script>
    (async function() {
      const TASK_DEFINITIONS = [
        {
          key: 'window',
          title: 'Send photo of a window',
          description: 'Confirm storefront visibility and merchandising.'
        },
        {
          key: 'trash',
          title: 'Send photo of trash cans',
          description: 'Ensure the waste disposal area is clean and labelled.'
        },
        {
          key: 'outfit',
          title: 'Send photo of an outfit',
          description: 'Confirm staff uniform compliance.'
        }
      ];

      const STATUS_LABELS = {
        not_submitted: 'Not submitted',
        waiting: 'Waiting for approval',
        approved: 'Approved',
        rejected: 'Not approved'
      };

      const STATUS_CLASSES = {
        not_submitted: 'status-not-submitted',
        waiting: 'status-waiting',
        approved: 'status-approved',
        rejected: 'status-rejected'
      };

      const profileDataRaw = sessionStorage.getItem('profileFormData');
      const grid = document.getElementById('pharmaciesGrid');
      const chipName = document.getElementById('chipName');
      const chipEmail = document.getElementById('chipEmail');
      const profileInitials = document.getElementById('profileInitials');
      const dashboardTitle = document.getElementById('dashboardTitle');
      const dashboardSubtitle = document.getElementById('dashboardSubtitle');
      const mapWrapper = document.getElementById('mapWrapper');
      const mapContainer = document.getElementById('pharmaciesMap');
      const profileLinkEl = document.getElementById('profileLink');
      const modalBackdrop = document.getElementById('pharmacyModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalAddress = document.getElementById('modalAddress');
      const modalEmployees = document.getElementById('modalEmployees');
      const modalTasks = document.getElementById('modalTasks');
      const modalClose = document.querySelector('.modal-close');

      let currentPharmacies = [];
      const submissionState = {};
      const coordsCache = (() => {
        try {
          return JSON.parse(localStorage.getItem('pharmacyCoordsCache') || '{}');
        } catch (err) {
          console.warn('Unable to parse coords cache', err);
          return {};
        }
      })();
      let mapInstance = null;
      let placemarkCollection = null;
      let isMapReady = false;
      let pendingPharmaciesForMap = [];

      function cacheCoords(key, coords) {
        coordsCache[key] = coords;
        try {
          localStorage.setItem('pharmacyCoordsCache', JSON.stringify(coordsCache));
        } catch (err) {
          console.warn('Unable to persist coords cache', err);
        }
      }

      function getCoordsFromCache(key) {
        const entry = coordsCache[key];
        if (Array.isArray(entry) && entry.length === 2) {
          return entry;
        }
        return null;
      }

      function getCacheKey(pharmacy) {
        return `${pharmacy.region || ''}|${pharmacy.address || ''}`;
      }

      function ensureMap(center) {
        if (!mapInstance) {
          const defaultCenter = Array.isArray(center) ? center : [55.751244, 37.618423];
          mapInstance = new ymaps.Map('pharmaciesMap', {
            center: defaultCenter,
            zoom: 11,
            controls: ['zoomControl', 'geolocationControl']
          });
          placemarkCollection = new ymaps.GeoObjectCollection();
          mapInstance.geoObjects.add(placemarkCollection);
        } else if (Array.isArray(center)) {
          mapInstance.setCenter(center, Math.min(mapInstance.getZoom(), 13));
        }
      }

      async function geocodePharmacy(pharmacy) {
        const key = getCacheKey(pharmacy);
        const cached = getCoordsFromCache(key);
        if (cached) {
          return cached;
        }
        if (!isMapReady) {
          return null;
        }
        try {
          const query = [pharmacy.region, pharmacy.address].filter(Boolean).join(', ');
          const response = await ymaps.geocode(query, { results: 1 });
          const firstGeoObject = response.geoObjects.get(0);
          if (firstGeoObject) {
            const coords = firstGeoObject.geometry.getCoordinates();
            if (Array.isArray(coords) && coords.length === 2) {
              cacheCoords(key, coords);
              return coords;
            }
          }
        } catch (err) {
          console.warn('Unable to geocode pharmacy', pharmacy, err);
        }
        return null;
      }

      async function updateMapWithPharmacies(pharmacies) {
        if (!Array.isArray(pharmacies) || pharmacies.length === 0) {
          if (mapWrapper) {
            mapWrapper.style.display = 'none';
          }
          if (mapInstance && placemarkCollection) {
            placemarkCollection.removeAll();
          }
          return;
        }

        if (!isMapReady || typeof ymaps === 'undefined' || !ymaps.Map) {
          pendingPharmaciesForMap = pharmacies.slice();
          return;
        }

        if (mapWrapper) {
          mapWrapper.style.display = 'block';
        }

        const coordsList = [];
        for (const pharmacy of pharmacies) {
          const coords = await geocodePharmacy(pharmacy);
          if (coords) {
            coordsList.push({ coords, pharmacy });
          }
        }

        if (!coordsList.length) {
          return;
        }

        ensureMap(coordsList[0].coords);
        placemarkCollection.removeAll();

        coordsList.forEach(({ coords, pharmacy }) => {
          const placemark = new ymaps.Placemark(coords, {
            balloonContentHeader: pharmacy.address || 'Pharmacy',
            balloonContentBody: [
              pharmacy.region ? `<div><strong>Region:</strong> ${pharmacy.region}</div>` : '',
              pharmacy.phone ? `<div><strong>Phone:</strong> ${pharmacy.phone}</div>` : '',
              pharmacy.hours ? `<div><strong>Hours:</strong> ${pharmacy.hours}</div>` : ''
            ].filter(Boolean).join('')
          }, {
            preset: 'islands#dotIcon',
            iconColor: '#2d5a27'
          });
          placemarkCollection.add(placemark);
        });

        const bounds = placemarkCollection.getBounds();
        if (bounds) {
          mapInstance.setBounds(bounds, { checkZoomRange: true, zoomMargin: 40 });
        }
      }

      if (typeof ymaps !== 'undefined' && ymaps.ready) {
        ymaps.ready(() => {
          isMapReady = true;
          if (pendingPharmaciesForMap.length) {
            updateMapWithPharmacies(pendingPharmaciesForMap);
            pendingPharmaciesForMap = [];
          }
        });
      }

      function buildProfileHref(role, email) {
        const params = new URLSearchParams();
        if (role) params.set('role', role);
        if (email) params.set('email', email);
        const suffix = params.toString();
        return suffix ? `profile.html?${suffix}` : 'profile.html';
      }

      function openFileUrl(fileUrl, fileName = 'submission') {
        if (!fileUrl) return;
        try {
          const link = document.createElement('a');
          link.href = fileUrl;
          link.target = '_blank';
          link.rel = 'noopener';
          link.download = fileName;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (err) {
          console.warn('Unable to open file via anchor, falling back to window.open', err);
          window.open(fileUrl, '_blank', 'noopener');
        }
      }

      function createEmptyTaskEntry(overrides = {}) {
        return Object.assign({
          state: 'not_submitted',
          submitted: false,
          fileName: '',
          fileUrl: '',
          employeeEmail: '',
          reviewerEmail: '',
          updatedAt: null,
          reviewedAt: null
        }, overrides);
      }

      function createEmptyTaskMap() {
        return TASK_DEFINITIONS.reduce((acc, task) => {
          acc[task.key] = createEmptyTaskEntry();
          return acc;
        }, {});
      }

      function normalizeEntry(entry) {
        if (!entry) return createEmptyTaskEntry();
        if (typeof entry !== 'object') {
          if (entry === 'waiting') {
            return createEmptyTaskEntry();
          }
          return createEmptyTaskEntry({
            state: entry,
            submitted: entry !== 'not_submitted'
          });
        }
        const normalized = createEmptyTaskEntry({
          state: entry.state || 'not_submitted',
          submitted: entry.submitted ?? (entry.state && entry.state !== 'not_submitted'),
          fileName: entry.fileName || entry.filename || '',
          fileUrl: entry.fileUrl || '',
          employeeEmail: entry.employeeEmail || entry.employee_email || '',
          reviewerEmail: entry.reviewerEmail || entry.reviewer_email || '',
          updatedAt: entry.updatedAt || entry.updated_at || null,
          reviewedAt: entry.reviewedAt || entry.reviewed_at || null
        });
        if (normalized.state === 'submitted') {
          normalized.state = 'waiting';
        }
        return normalized;
      }

      function ensurePharmacyState(indexKey) {
        if (!submissionState[indexKey]) {
          submissionState[indexKey] = createEmptyTaskMap();
        }
        return submissionState[indexKey];
      }

      function getTaskStatusFor(indexKey) {
        const store = ensurePharmacyState(indexKey);
        Object.keys(store).forEach(taskKey => {
          store[taskKey] = normalizeEntry(store[taskKey]);
        });
        return store;
      }

      function mergeSubmissionsIntoState(targetState, submissions) {
        submissions.forEach(item => {
          if (!item || !item.task_key) return;
          const indexKey = String(item.pharmacy_index);
          const store = ensurePharmacyState(indexKey);
          const existing = store[item.task_key];
          const existingUpdated = existing?.updatedAt ? new Date(existing.updatedAt).getTime() : 0;
          const incomingUpdated = item.updated_at ? new Date(item.updated_at).getTime() : 0;
          if (!existingUpdated || incomingUpdated >= existingUpdated) {
            store[item.task_key] = createEmptyTaskEntry({
              state: item.status || 'waiting',
              submitted: item.status ? item.status !== 'not_submitted' : true,
              fileName: item.file_name || '',
              fileUrl: item.file_url || '',
              employeeEmail: item.employee_email || '',
              reviewerEmail: item.reviewer_email || '',
              updatedAt: item.updated_at || null,
              reviewedAt: item.reviewed_at || null
            });
          }
        });
      }

      async function fetchSubmissions(query) {
        const params = new URLSearchParams();
        Object.entries(query || {}).forEach(([key, value]) => {
          if (value === undefined || value === null || value === '') return;
          params.append(key, Array.isArray(value) ? value.join(',') : value);
        });
        const response = await fetch(`/api/get-submissions?${params.toString()}`);
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || 'Unable to fetch submissions');
        }
        const data = await response.json();
        if (!data?.ok) throw new Error('Unexpected response');
        return data.submissions || [];
      }

      function formatStatusNote(status, entry) {
        switch (status) {
          case 'waiting':
            return entry.employeeEmail
              ? `Submitted by ${entry.employeeEmail} • Awaiting your review.`
              : 'Submitted by employee • Awaiting your review.';
          case 'approved':
            return entry.reviewerEmail
              ? `Approved by ${entry.reviewerEmail}.`
              : 'Approved.';
          case 'rejected':
            return entry.reviewerEmail
              ? `Rejected by ${entry.reviewerEmail}.`
              : 'Marked for resubmission.';
          default:
            return 'No submission yet.';
        }
      }

      async function hydrateRgaState(pharmacies) {
        const indexes = (pharmacies || [])
          .map(item => item?.index)
          .filter(index => index !== undefined && index !== null);
        if (!indexes.length) return;
        try {
          const submissions = await fetchSubmissions({ pharmacies: indexes, role: 'rga' });
          mergeSubmissionsIntoState(submissionState, submissions);
        } catch (error) {
          console.warn('Unable to load submissions for RGA', error);
        }
      }

      function renderPharmacyCard(pharmacy) {
        const indexKey = String(pharmacy.index);
        const taskStatuses = getTaskStatusFor(indexKey);
        const meta = [
          pharmacy.region,
          pharmacy.address,
          pharmacy.phone ? `Тел.: ${pharmacy.phone}` : null
        ].filter(Boolean).join(' • ');

        const taskItems = TASK_DEFINITIONS.map(task => {
          const entry = normalizeEntry(taskStatuses[task.key]);
          const status = entry.state || 'not_submitted';
          const statusClass = STATUS_CLASSES[status] || STATUS_CLASSES.waiting;
          const statusLabel = STATUS_LABELS[status] || STATUS_LABELS.waiting;
          const note = formatStatusNote(status, entry);
          const actionButtons = [];

          if (entry.fileUrl) {
            actionButtons.push(`<button type="button" class="task-action-btn open" data-action="open" data-task="${task.key}" data-pharmacy-index="${indexKey}">Open</button>`);
          }

          if (status === 'waiting') {
            actionButtons.push(
              `<button type="button" class="task-action-btn approve" data-action="approve" data-task="${task.key}" data-pharmacy-index="${indexKey}">Approve</button>`,
              `<button type="button" class="task-action-btn delete" data-action="reject" data-task="${task.key}" data-pharmacy-index="${indexKey}">Reject</button>`
            );
          }

          const actionsHtml = actionButtons.length
            ? `<div class="task-actions">${actionButtons.join('')}</div>`
            : '';

          return `
            <div class="task-item" data-task="${task.key}">
              <div>
                <h3>${task.title}</h3>
                <p>${task.description}</p>
              </div>
              <div class="task-status" style="align-items:flex-end;">
                <div>
                  <div class="status-chip ${statusClass}" data-status-label data-task="${task.key}" data-pharmacy-index="${indexKey}" data-state="${status}" data-filename="${entry.fileName || ''}" data-fileurl="${entry.fileUrl || ''}">${statusLabel}</div>
                  <p style="margin:6px 0 0; font-size:12px; color:${status === 'waiting' ? '#b45309' : '#64748b'}; font-weight:${status === 'waiting' ? '600' : '400'};">${note}</p>
                </div>
                ${actionsHtml}
              </div>
            </div>
          `;
        }).join('');

        return `
          <article class="pharmacy-card" data-index="${indexKey}">
            <h2>${pharmacy.address}</h2>
            <small>${meta}</small>
            <div class="task-list">
              ${taskItems}
            </div>
          </article>
        `;
      }

      function renderPharmacies() {
        if (!grid) return;
        grid.innerHTML = currentPharmacies.map(renderPharmacyCard).join('');
      }

      if (!profileDataRaw) {
        grid.innerHTML = '<p style="color:#64748b;">No profile data found. Please complete your profile first.</p>';
        if (profileLinkEl) {
          profileLinkEl.href = 'profile.html';
        }
        if (mapWrapper) {
          mapWrapper.style.display = 'none';
        }
        return;
      }

      let profileData = null;
      try {
        profileData = JSON.parse(profileDataRaw);
      } catch (err) {
        console.error('Failed to parse profile data', err);
      }

      if (!profileData) {
        grid.innerHTML = '<p style="color:#64748b;">No profile data found. Please complete your profile first.</p>';
        if (mapWrapper) {
          mapWrapper.style.display = 'none';
        }
        return;
      }

      const firstName = profileData.first_name || '';
      const lastName = profileData.last_name || '';
      const email = profileData.email || sessionStorage.getItem('userEmail') || '—';
      const pharmacies = Array.isArray(profileData.pharmacies) ? profileData.pharmacies : [];

      chipName.textContent = `${firstName} ${lastName}`.trim() || '—';
      chipEmail.textContent = email;
      profileInitials.textContent = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase() || 'R';
      if (profileLinkEl) {
        profileLinkEl.href = buildProfileHref(profileData.role, profileData.email);
      }

      if (!pharmacies.length) {
        grid.innerHTML = '<p style="color:#64748b;">No pharmacies assigned yet.</p>';
        if (mapWrapper) {
          mapWrapper.style.display = 'none';
        }
        return;
      }

      dashboardTitle.textContent = `${firstName || lastName ? `${firstName} ${lastName}`.trim() + '\'s' : 'RGA'} Dashboard`;
      dashboardSubtitle.textContent = 'Review submission status for each pharmacy under your supervision.';

      currentPharmacies = pharmacies;
      renderPharmacies();
      await hydrateRgaState(currentPharmacies);
      renderPharmacies();

      if (!mapInstance && mapContainer) {
        mapContainer.innerHTML = '';
      }
      await updateMapWithPharmacies(currentPharmacies);

      grid.addEventListener('click', async (event) => {
        if (event.target.closest('.status-chip')) {
          return;
        }

        const actionBtn = event.target.closest('.task-action-btn');
        if (actionBtn) {
          const action = actionBtn.dataset.action;
          const taskKey = actionBtn.dataset.task;
          const pharmacyIndex = actionBtn.dataset.pharmacyIndex;
          const store = ensurePharmacyState(pharmacyIndex);
          const entry = normalizeEntry(store[taskKey]);

          if (action === 'open') {
            if (entry.fileUrl) {
              openFileUrl(entry.fileUrl, entry.fileName || 'submission');
            } else {
              const fileName = entry.fileName || 'Submitted file';
              alert(`Employee uploaded: ${fileName}`);
            }
            return;
          }

          if (action === 'approve' || action === 'reject') {
            if (!entry.employeeEmail) {
              alert('Unable to locate the employee who submitted this task.');
              return;
            }
            const nextState = action === 'approve' ? 'approved' : 'rejected';
            try {
              const response = await fetch('/api/update-submission-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  employeeEmail: entry.employeeEmail,
                  pharmacyIndex: Number(pharmacyIndex),
                  taskKey,
                  status: nextState,
                  reviewerEmail: email || ''
                })
              });
              const data = await response.json();
              if (!response.ok || !data?.ok) {
                throw new Error(data?.error || 'Failed to update status');
              }
              if (data.submission) {
                mergeSubmissionsIntoState(submissionState, [data.submission]);
              } else {
                store[taskKey] = createEmptyTaskEntry({
                  state: nextState,
                  submitted: true,
                  fileName: entry.fileName,
                  fileUrl: entry.fileUrl,
                  employeeEmail: entry.employeeEmail,
                  reviewerEmail: email || '',
                  reviewedAt: new Date().toISOString(),
                  updatedAt: new Date().toISOString()
                });
              }
              renderPharmacies();
            } catch (error) {
            console.error('Unable to update submission status', error);
            const parentTask = actionBtn.closest('.task-item');
            const statusNoteEl = parentTask?.querySelector('.task-status p');
            if (statusNoteEl) {
              statusNoteEl.textContent = 'Unable to update status. Please try again later.';
              statusNoteEl.style.color = '#b91c1c';
              statusNoteEl.style.fontWeight = '600';
            }
            }
            return;
          }
        }

        const card = event.target.closest('.pharmacy-card');
        const isActionArea = event.target.closest('.task-actions');
        if (card && !isActionArea) {
          const indexKey = card.dataset.index;
          const pharmacy = currentPharmacies.find(item => String(item.index) === indexKey);
          if (pharmacy) {
            openPharmacyModal(pharmacy);
          }
        }
      });

      function openPharmacyModal(pharmacy) {
        if (!modalBackdrop) return;
        modalBackdrop.classList.add('active');
        modalTitle.textContent = pharmacy.address || 'Pharmacy';
        modalAddress.textContent = [pharmacy.region || '', pharmacy.phone || '', pharmacy.hours || ''].filter(Boolean).join(' • ');

        const employeesStore = JSON.parse(localStorage.getItem('pharmacyEmployees') || '{}');
        const employees = employeesStore[String(pharmacy.index)] || [];
        if (!employees.length) {
          modalEmployees.innerHTML = '<li>No employees assigned yet.</li>';
        } else {
          modalEmployees.innerHTML = employees.map(employee => `<li>${employee.name} <span style="color:#94a3b8">(${employee.email})</span></li>`).join('');
        }

        const taskStatuses = getTaskStatusFor(String(pharmacy.index));
        modalTasks.innerHTML = TASK_DEFINITIONS.map(task => {
          const entry = normalizeEntry(taskStatuses[task.key]);
          const status = entry.state || 'not_submitted';
          const label = STATUS_LABELS[status] || STATUS_LABELS.waiting;
          return `<li><strong>${task.title}:</strong> ${label}</li>`;
        }).join('');
      }

      function closeModal() {
        modalBackdrop?.classList.remove('active');
      }

      modalBackdrop?.addEventListener('click', (event) => {
        if (event.target === modalBackdrop) {
          closeModal();
        }
      });

      modalClose?.addEventListener('click', closeModal);

      setInterval(() => {
        if (!currentPharmacies.length) return;
        hydrateRgaState(currentPharmacies)
          .then(() => {
            renderPharmacies();
            return updateMapWithPharmacies(currentPharmacies);
          })
          .catch(err => console.warn('Periodic refresh failed', err));
      }, 30000);

      grid.addEventListener('click', async (event) => {
        const chip = event.target.closest('.status-chip');
        if (!chip) return;
        const state = chip.dataset.state;
        if (state !== 'waiting' && state !== 'approved' && state !== 'rejected') {
          alert('No submission available to review yet.');
          return;
        }
        const taskKey = chip.dataset.task;
        const pharmacyIndex = chip.dataset.pharmacyIndex;
        const store = ensurePharmacyState(pharmacyIndex);
        const entry = normalizeEntry(store[taskKey]);
        if (entry.fileUrl) {
          openFileUrl(entry.fileUrl, entry.fileName || 'submission');
        } else {
          const fileName = entry.fileName || 'Submitted file';
          alert(`Employee uploaded: ${fileName}`);
        }
      });
    })();
  </script>
</body>
</html>

