================================================================================
PHARMAT AUDIT SYSTEM - COMPLETE CODEBASE
================================================================================
This file contains all code files from the PharmaT Audit System project.
You can upload this entire file to GPT/ChatGPT to get answers about your code.

================================================================================
FILE: index.html
================================================================================

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>PharmaT audit</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .container {
    background: white;
    padding: 50px;
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    text-align: center;
    max-width: 600px;
  }
  
  h1 {
    color: #2d5a27;
    font-size: 36px;
    margin-bottom: 20px;
    font-weight: 600;
  }
  
  p {
    color: #666;
    font-size: 18px;
    line-height: 1.6;
    margin-bottom: 15px;
  }
  
  .register-btn {
    display: inline-block;
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
    padding: 15px 40px;
    text-decoration: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
    margin-top: 20px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }
  
  .register-btn:hover {
    background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
  }
  
  .register-btn:active {
    transform: translateY(0);
  }

  @media (max-width: 768px) {
    body {
      padding: 16px 12px;
    }

    .container {
      padding: 30px 24px;
      border-radius: 12px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 16px;
    }

    p {
      font-size: 16px;
      margin-bottom: 12px;
    }

    .register-btn {
      padding: 14px 30px;
      font-size: 16px;
      min-height: 48px;
    }
  }

  @media (max-width: 480px) {
    body {
      padding: 12px 8px;
    }

    .container {
      padding: 24px 20px;
    }

    h1 {
      font-size: 24px;
    }

    p {
      font-size: 15px;
    }

    .register-btn {
      padding: 16px 24px;
      font-size: 17px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Welcome to the PharmaT audit</h1>
    <p>This is a simple audit tool for the PharmaT project.</p>
    <p>Please register to continue</p>
    <a href="register.html" class="register-btn">Register</a>
  </div>
</body>
</html>

================================================================================
FILE: register.html
================================================================================

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Registration Step 1</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 450px;
    }
    
    h2 {
      color: #2d5a27;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
    }
    
    label {
      display: block;
      margin-bottom: 15px;
      color: #333;
      font-weight: 500;
    }
    
    select, input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }
    
    button:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .error {
      color: #f44336;
      background: #ffebee;
      padding: 10px 15px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 4px solid #f44336;
      font-size: 14px;
    }
    
    .hidden { display: none; }
    
    .form-group {
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 12px;
      }

      .container {
        padding: 28px 24px;
        border-radius: 12px;
      }

      h2 {
        font-size: 24px;
        margin-bottom: 24px;
      }

      label {
        margin-bottom: 12px;
        font-size: 15px;
      }

      select, input {
        padding: 14px 16px;
        font-size: 16px;
        min-height: 48px;
      }

      button {
        padding: 16px 24px;
        font-size: 17px;
        min-height: 48px;
      }

      #loginModal > div {
        margin: 16px;
        padding: 28px 24px;
        max-width: calc(100% - 32px);
      }

      #closeLoginModal {
        top: 8px;
        right: 12px;
        font-size: 28px;
        padding: 4px 8px;
        min-width: 44px;
        min-height: 44px;
      }

      #togglePassword, #toggleLoginPassword {
        min-width: 44px;
        min-height: 44px;
        font-size: 20px;
      }

      .error {
        padding: 12px 16px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px 8px;
      }

      .container {
        padding: 24px 20px;
      }

      h2 {
        font-size: 22px;
      }

      select, input {
        padding: 16px;
        font-size: 16px;
      }

      button {
        padding: 18px 20px;
        font-size: 18px;
      }

      #loginModal > div {
        padding: 24px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">Registration</h2>
      <button id="loginBtnTop" style="background: none; color: #666; border: none; padding: 4px 8px; cursor: pointer; font-size: 14px; text-decoration: underline;">
        Log In
      </button>
    </div>
    <form id="step1Form">
      <div class="form-group">
        <label>
          Select your role:
          <select id="roleSelect" required>
            <option value="" disabled selected>Select role</option>
            <option value="employee">Employee</option>
            <option value="rga">RGA</option>
          </select>
        </label>
      </div>
      
      <div class="form-group">
        <label>
          Email:
          <input type="email" id="emailInput" required />
        </label>
        <button type="button" id="sendCodeBtn" style="margin-top:10px; width:100%">Send verification code</button>
      </div>

      <div class="form-group hidden" id="codeGroup">
        <label>
          Enter code from email:
          <input type="text" id="codeInput" placeholder="6-digit code" maxlength="6" pattern="[0-9]{6}" />
        </label>
        <button type="button" id="verifyCodeBtn" style="margin-top:10px; width:100%">Verify code</button>
        <div id="verifyMsg" class="error" style="display:none"></div>
      </div>
      
      <div class="form-group">
        <label>
          Password:
          <div style="position: relative;">
            <input type="password" id="passportInput" required style="padding-right: 40px; width: 100%;" />
            <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-80%); background: none; border: none; cursor: pointer; padding: 4px; color: #666; font-size: 18px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
              üëÅ
            </button>
          </div>
        </label>
      </div>
      
      <div id="errorMsg" class="error" style="display: none;"></div>
      <button type="submit">Next</button>
    </form>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; margin: 20px; position: relative;">
      <button id="closeLoginModal" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; z-index: 10;">&times;</button>
      <div style="margin-bottom: 30px; text-align: center;">
        <h2 style="margin: 0; color: #2d5a27;">Log In</h2>
      </div>
      
      <form id="loginForm">
        <div class="form-group">
          <label>
            Email:
            <input type="email" id="loginEmail" required />
          </label>
        </div>
        
        <div class="form-group">
          <label>
            Password:
            <div style="position: relative;">
              <input type="password" id="loginPassword" required style="padding-right: 40px; width: 100%;" />
              <button type="button" id="toggleLoginPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-80%); background: none; border: none; cursor: pointer; padding: 4px; color: #666; font-size: 18px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                üëÅ
              </button>
            </div>
          </label>
        </div>
        
        <div id="loginErrorMsg" class="error" style="display: none;"></div>
        <button type="submit" style="width: 100%;">Log In</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false
      }
    });
    
    const step1Form = document.getElementById('step1Form');
    const errorMsg = document.getElementById('errorMsg');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const codeGroup = document.getElementById('codeGroup');
    const verifyMsg = document.getElementById('verifyMsg');
    const codeInput = document.getElementById('codeInput');
    const passportInput = document.getElementById('passportInput');
    const togglePassword = document.getElementById('togglePassword');
    const loginModal = document.getElementById('loginModal');
    const loginBtnTop = document.getElementById('loginBtnTop');
    const closeLoginModal = document.getElementById('closeLoginModal');
    const loginForm = document.getElementById('loginForm');
    const loginErrorMsg = document.getElementById('loginErrorMsg');
    const loginPassword = document.getElementById('loginPassword');
    const toggleLoginPassword = document.getElementById('toggleLoginPassword');

    // Password requirements
    const correctPasswords = {
      'rga': 'Sosiska1',
      'employee': 'Sosiska2'
    };

    // Restrict code input to only numbers and max 6 digits
    codeInput.addEventListener('input', function(e) {
      // Remove any non-numeric characters
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
      // Limit to 6 digits
      if (e.target.value.length > 6) {
        e.target.value = e.target.value.slice(0, 6);
      }
    });

    // Prevent non-numeric input
    codeInput.addEventListener('keypress', function(e) {
      if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
      }
    });

    // Password visibility toggle
    togglePassword.addEventListener('click', function() {
      if (passportInput.type === 'password') {
        passportInput.type = 'text';
        togglePassword.textContent = 'üôà';
      } else {
        passportInput.type = 'password';
        togglePassword.textContent = 'üëÅ';
      }
    });

    // Login modal functionality
    loginBtnTop.addEventListener('click', function() {
      loginModal.style.display = 'flex';
      loginModal.style.alignItems = 'center';
      loginModal.style.justifyContent = 'center';
    });

    closeLoginModal.addEventListener('click', function() {
      loginModal.style.display = 'none';
      loginErrorMsg.style.display = 'none';
      loginForm.reset();
    });

    // Close modal when clicking outside
    loginModal.addEventListener('click', function(e) {
      if (e.target === loginModal) {
        loginModal.style.display = 'none';
        loginErrorMsg.style.display = 'none';
        loginForm.reset();
      }
    });

    // Login password visibility toggle
    toggleLoginPassword.addEventListener('click', function() {
      if (loginPassword.type === 'password') {
        loginPassword.type = 'text';
        toggleLoginPassword.textContent = 'üôà';
      } else {
        loginPassword.type = 'password';
        toggleLoginPassword.textContent = 'üëÅ';
      }
    });
    
    // Force deployment trigger
    console.log('Password toggle initialized');

    step1Form.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent form submission to server
      
      errorMsg.textContent = ''; // Clear previous errors

      const role = document.getElementById('roleSelect').value;
      const email = document.getElementById('emailInput').value.trim();
      const passport = document.getElementById('passportInput').value.trim();

      // Validate role selected
      if (!role) {
        errorMsg.textContent = 'Please select a role.';
        return;
      }

      // Validate email format (HTML5 email type input handles basic check)
      if (!email) {
        errorMsg.textContent = 'Please enter your email.';
        return;
      }

      // Validate passport matches the required password for the role
      if (!passport || passport.trim() === '') {
        errorMsg.textContent = 'Please enter a password.';
        return;
      }

      const requiredPassword = correctPasswords[role];
      if (passport !== requiredPassword) {
        errorMsg.textContent = 'Incorrect password for this role.';
        errorMsg.style.display = 'block';
        errorMsg.style.background = '#fee2e2';
        errorMsg.style.color = '#b91c1c';
        errorMsg.style.borderLeft = '4px solid #fca5a5';
        return;
      }

      // Ensure email verified before proceeding
      const isVerified = codeGroup.dataset.verified === 'true';
      if (!isVerified) {
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#fff3cd';
        verifyMsg.style.color = '#856404';
        verifyMsg.style.borderLeft = '4px solid #ffc107';
        verifyMsg.textContent = 'Please verify your email with the code before continuing.';
        return;
      }

      // If all validations pass, save to database
      console.log('All validations passed, saving to database...');
      saveUserToDatabase(role, email);
    });

    // Send verification code
    sendCodeBtn.addEventListener('click', async () => {
      console.log('Send code button clicked!');
      const email = document.getElementById('emailInput').value.trim();
      errorMsg.style.display = 'none';
      verifyMsg.style.display = 'none';
      codeGroup.dataset.verified = 'false';
      
      if (!email) {
        errorMsg.textContent = 'Please enter your email first.';
        errorMsg.style.display = 'block';
        return;
      }
      
      console.log('Sending request for email:', email);
      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'Sending...';
      
      // Check if email is already registered
      try {
        const checkEmailResponse = await fetch('/api/check-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const emailCheckResult = await checkEmailResponse.json();
        if (emailCheckResult.exists) {
          errorMsg.innerHTML = `
            <div style="text-align: center;">
              <p style="margin: 0 0 15px 0; font-weight: 600; color: #f44336;">User is already registered</p>
              <button type="button" id="loginBtnFromError" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                Log In Instead
              </button>
            </div>
          `;
          errorMsg.style.display = 'block';
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'Send verification code';
          return;
        }
      } catch (emailCheckError) {
        console.log('Email check failed, proceeding with code sending:', emailCheckError);
      }
      
      try {
        const resp = await fetch('/api/send-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const result = await resp.json();
        
        if (!resp.ok) {
          throw new Error(result?.error || 'Failed to send code');
        }
        
        // Show the code input section
        codeGroup.classList.remove('hidden');
        verifyMsg.style.display = 'block';
        
        // Handle different response scenarios
        console.log('API Response:', result);
        
        if (result?.devCode) {
          // Development mode - show the code
          verifyMsg.style.background = '#fff3cd';
          verifyMsg.style.color = '#856404';
          verifyMsg.style.borderLeft = '4px solid #ffc107';
          verifyMsg.innerHTML = `
            <strong>Development Mode:</strong><br>
            Email not configured. Your verification code is: <strong>${result.devCode}</strong><br>
            <small>${result.note || ''}</small>
          `;
          
          if (result.setupInstructions) {
            verifyMsg.innerHTML += '<br><br><strong>To enable email sending:</strong><br>' + 
              result.setupInstructions.map(instruction => `<small>‚Ä¢ ${instruction}</small>`).join('<br>');
          }
        } else if (result?.ok === true) {
          // Email sent successfully
          verifyMsg.style.background = '#d4edda';
          verifyMsg.style.color = '#155724';
          verifyMsg.style.borderLeft = '4px solid #28a745';
          verifyMsg.textContent = 'Verification code sent to your email!';
        } else if (result?.emailError) {
          // Email sending failed but we have a fallback code
          verifyMsg.style.background = '#fff3cd';
          verifyMsg.style.color = '#856404';
          verifyMsg.style.borderLeft = '4px solid #ffc107';
          verifyMsg.innerHTML = `
            <strong>Email sending failed:</strong><br>
            Your verification code is: <strong>${result.devCode}</strong><br>
            <small>${result.note || ''}</small>
          `;
        } else {
          // Email sent successfully
          verifyMsg.style.background = '#d4edda';
          verifyMsg.style.color = '#155724';
          verifyMsg.style.borderLeft = '4px solid #28a745';
          verifyMsg.textContent = result.message || 'Verification code sent to your email!';
        }
        
      } catch (e) {
        errorMsg.textContent = e.message;
        errorMsg.style.display = 'block';
      } finally {
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'Send verification code';
      }
    });

    // Verify code
    verifyCodeBtn.addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      const code = document.getElementById('codeInput').value.trim();
      verifyMsg.style.display = 'none';
      if (!email || !code) {
        verifyMsg.textContent = 'Enter the code sent to your email.';
        verifyMsg.style.display = 'block';
        return;
      }
      
      // Validate code is exactly 6 digits
      if (!/^[0-9]{6}$/.test(code)) {
        verifyMsg.style.background = '#fee2e2';
        verifyMsg.style.color = '#b91c1c';
        verifyMsg.style.borderLeft = '4px solid #fca5a5';
        verifyMsg.textContent = 'Please enter a valid 6-digit code.';
        verifyMsg.style.display = 'block';
        return;
      }
      verifyCodeBtn.disabled = true;
      verifyCodeBtn.textContent = 'Verifying...';
      try {
        const resp = await fetch('/api/verify-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code })
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result?.error || 'Verification failed');
        codeGroup.dataset.verified = 'true';
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#e8f5e8';
        verifyMsg.style.color = '#2d5a27';
        verifyMsg.textContent = 'Email verified successfully!';
      } catch (e) {
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#fee2e2';
        verifyMsg.style.color = '#b91c1c';
        verifyMsg.style.borderLeft = '4px solid #fca5a5';
        verifyMsg.textContent = e.message;
        codeGroup.dataset.verified = 'false';
      } finally {
        verifyCodeBtn.disabled = false;
        verifyCodeBtn.textContent = 'Verify code';
      }
    });

    // Function to save user data to Supabase
    async function saveUserToDatabase(role, email) {
      try {
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;

        console.log('Attempting to save user:', { role, email });

        // Call serverless API to avoid CORS/network issues
        const apiResponse = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role, email })
        });

        const result = await apiResponse.json();
        if (!apiResponse.ok) {
          console.error('API error:', result);
          throw new Error(result?.error || 'Failed to save via API');
        }

        console.log('User saved successfully via API:', result);
        
        // Store user role for profile completion
        sessionStorage.setItem('userRole', role);
        sessionStorage.setItem('userEmail', email);
        
        // Success - proceed to profile completion
        window.location.href = `profile.html?role=${role}&email=${email}`;

      } catch (err) {
        console.error('Registration error:', err);
        
        // Check if it's a duplicate email error
        if (err.message.includes('duplicate key value violates unique constraint') || 
            err.message.includes('users_email_key') ||
            err.message.includes('duplicate')) {
          errorMsg.innerHTML = `
            <div style="text-align: center;">
              <p style="margin: 0 0 15px 0; font-weight: 600;">User is already registered</p>
              <button type="button" id="loginBtn" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                Log In
              </button>
            </div>
          `;
        } else {
          errorMsg.textContent = `Registration failed: ${err.message}`;
        }
        errorMsg.style.display = 'block';
      } finally {
        // Reset button state
        const submitBtn = document.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Next';
        submitBtn.disabled = false;
      }
    }
    
    // Handle Log In button click
    document.addEventListener('click', function(e) {
      if (e.target.id === 'loginBtn' || e.target.id === 'loginBtnFromError') {
        loginModal.style.display = 'flex';
      }
    });

    // Login form submission
    loginForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      
      loginErrorMsg.style.display = 'none';
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      
      if (!email || !password) {
        loginErrorMsg.textContent = 'Please fill in all fields.';
        loginErrorMsg.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          try {
            sessionStorage.setItem('userRole', result.role);
            sessionStorage.setItem('userEmail', email);
          } catch (storageErr) {
            console.warn('Unable to persist session data', storageErr);
          }

          try {
            const profileResponse = await fetch(`/api/get-profile?email=${encodeURIComponent(email)}`);
            if (profileResponse.ok) {
              const profilePayload = await profileResponse.json();
              if (profilePayload?.profile) {
                try {
                  sessionStorage.setItem('profileFormData', JSON.stringify(profilePayload.profile));
                } catch (cacheErr) {
                  console.warn('Unable to cache profile data', cacheErr);
                }
                if ((result.role || '').toLowerCase() === 'rga') {
                  window.location.href = 'rga-dashboard.html';
                } else {
                  window.location.href = 'welcome.html';
                }
                return;
              }
            }
          } catch (profileErr) {
            console.warn('Unable to load profile data during login', profileErr);
          }

          try {
            sessionStorage.removeItem('profileFormData');
          } catch (clearErr) {
            console.warn('Unable to clear cached profile data', clearErr);
          }
          window.location.href = `profile.html?role=${encodeURIComponent(result.role)}&email=${encodeURIComponent(email)}`;
        } else {
          loginErrorMsg.textContent = result.error || 'Login failed';
          loginErrorMsg.style.display = 'block';
        }
      } catch (error) {
        loginErrorMsg.textContent = 'Login failed. Please try again.';
        loginErrorMsg.style.display = 'block';
      }
    });
    
  </script>
</body>
</html>

================================================================================
FILE: profile.html
================================================================================
[Note: This file is very long (1327 lines). Including key sections...]

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Complete Your Profile</title>
  <style>
    /* ... CSS styles ... */
  </style>
</head>
<body>
  <div class="container">
    <!-- HTML structure -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';
    
    // ... JavaScript code for profile management ...
    // [Full code available in profile.html - 1327 lines total]
  </script>
</body>
</html>

================================================================================
FILE: welcome.html
================================================================================
[Note: This file is very long (1187 lines). Including key sections...]

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Daily Tasks | PharmaT Audit</title>
  <style>
    /* ... CSS styles ... */
  </style>
</head>
<body>
  <!-- HTML structure -->
  <script>
    // ... JavaScript code for employee dashboard ...
    // [Full code available in welcome.html - 1187 lines total]
  </script>
</body>
</html>

================================================================================
FILE: rga-dashboard.html
================================================================================
[Note: This file is very long (1115 lines). Including key sections...]

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>RGA Dashboard | PharmaT Audit</title>
  <style>
    /* ... CSS styles ... */
  </style>
</head>
<body>
  <!-- HTML structure -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <script>
    // ... JavaScript code for RGA dashboard ...
    // [Full code available in rga-dashboard.html - 1115 lines total]
  </script>
</body>
</html>

================================================================================
FILE: audit.html
================================================================================

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>PharmaT Audit - Questions</title>
  <style>
    /* ... CSS styles ... */
  </style>
</head>
<body>
  <div class="container">
    <h1>PharmaT Audit Questions</h1>
    
    <div class="progress">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    
    <form id="auditForm">
      <div id="questionsContainer">
        <!-- Questions will be loaded here -->
      </div>
      
      <div id="errorMsg" class="error" style="display: none;"></div>
      <div id="successMsg" class="success" style="display: none;"></div>
      
      <button type="submit" class="submit-btn">Submit Audit</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let questions = [];
    let currentUser = null;
    let auditSession = null;
    
    // Load questions from Supabase
    async function loadQuestions() {
      try {
        const { data, error } = await supabase
          .from('audit_questions')
          .select('*')
          .order('order_index');
          
        if (error) throw error;
        
        questions = data;
        renderQuestions();
        updateProgress();
      } catch (err) {
        console.error('Error loading questions:', err);
        showError('Failed to load audit questions. Please refresh the page.');
      }
    }
    
    // Render questions in the form
    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      
      questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        questionDiv.innerHTML = `
          <h3>Question ${index + 1}: ${question.question_text}</h3>
          ${renderQuestionInput(question, index)}
        `;
        container.appendChild(questionDiv);
      });
    }
    
    // Render different input types based on question type
    function renderQuestionInput(question, index) {
      const name = `question_${question.id}`;
      
      switch (question.question_type) {
        case 'text':
          return `<textarea name="${name}" placeholder="Enter your answer..." ${question.required ? 'required' : ''}></textarea>`;
          
        case 'multiple_choice':
          const options = question.options || [];
          let optionsHtml = '';
          options.forEach((option, i) => {
            optionsHtml += `<label><input type="radio" name="${name}" value="${option}" ${question.required ? 'required' : ''}> ${option}</label>`;
          });
          return optionsHtml;
          
        case 'yes_no':
          return `
            <label><input type="radio" name="${name}" value="yes" ${question.required ? 'required' : ''}> Yes</label>
            <label><input type="radio" name="${name}" value="no" ${question.required ? 'required' : ''}> No</label>
          `;
          
        case 'rating':
          return `
            <div class="rating">
              <input type="range" name="${name}" min="1" max="10" value="5" ${question.required ? 'required' : ''}>
              <span class="rating-value">5</span>
            </div>
          `;
          
        default:
          return `<input type="text" name="${name}" placeholder="Enter your answer..." ${question.required ? 'required' : ''}>`;
      }
    }
    
    // Update progress bar
    function updateProgress() {
      const totalQuestions = questions.length;
      const answeredQuestions = document.querySelectorAll('input:checked, textarea:not(:placeholder-shown), input[type="text"]:not(:placeholder-shown)').length;
      const progress = (answeredQuestions / totalQuestions) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
    }
    
    // Handle form submission
    document.getElementById('auditForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      
      try {
        // Collect form data
        const formData = new FormData(event.target);
        const responses = [];
        
        questions.forEach(question => {
          const name = `question_${question.id}`;
          const value = formData.get(name);
          if (value) {
            responses.push({
              question_id: question.id,
              response: value
            });
          }
        });
        
        // Save responses to database
        await saveAuditResponses(responses);
        
        showSuccess('Audit submitted successfully! Thank you for your participation.');
        
      } catch (err) {
        console.error('Error submitting audit:', err);
        showError('Failed to submit audit. Please try again.');
      }
    });
    
    // Save audit responses to Supabase
    async function saveAuditResponses(responses) {
      // Create audit session first
      const { data: sessionData, error: sessionError } = await supabase
        .from('audit_sessions')
        .insert([{
          session_name: `Audit Session - ${new Date().toLocaleString()}`,
          session_data: { responses: responses },
          status: 'completed'
        }])
        .select();
        
      if (sessionError) throw sessionError;
      
      // Save individual responses
      const responseData = responses.map(response => ({
        session_id: sessionData[0].id,
        question_id: response.question_id,
        response: response.response
      }));
      
      const { error: responsesError } = await supabase
        .from('audit_responses')
        .insert(responseData);
        
      if (responsesError) throw responsesError;
    }
    
    // Show error message
    function showError(message) {
      const errorDiv = document.getElementById('errorMsg');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('successMsg').style.display = 'none';
    }
    
    // Show success message
    function showSuccess(message) {
      const successDiv = document.getElementById('successMsg');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      document.getElementById('errorMsg').style.display = 'none';
    }
    
    // Add event listeners for progress tracking
    document.addEventListener('input', updateProgress);
    document.addEventListener('change', updateProgress);
    
    // Initialize the page
    loadQuestions();
  </script>
</body>
</html>

================================================================================
API ENDPOINTS
================================================================================

================================================================================
FILE: api/register.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { role, email } = req.body || {};
    if (!role || !email) {
      res.status(400).json({ error: 'Missing role or email' });
      return;
    }

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    const response = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify([{ email, role }])
    });

    const data = await response.json().catch(() => ({}));

    if (!response.ok) {
      res.status(response.status).json({ error: data?.message || 'Insert failed', details: data });
      return;
    }

    res.status(200).json({ data });
  } catch (error) {
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/login.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email, password } = req.body || {};
    
    if (!email || !password) {
      res.status(400).json({ error: 'Email and password are required' });
      return;
    }
    
    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';
    
    // Look up user by email
    const response = await fetch(`${SUPABASE_URL}/rest/v1/users?email=eq.${encodeURIComponent(email)}&select=*`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    if (!response.ok) {
      console.error('Supabase error:', await response.text());
      res.status(500).json({ error: 'Database error' });
      return;
    }
    
    const users = await response.json();
    
    if (!users || users.length === 0) {
      res.status(401).json({ error: 'Invalid email or password' });
      return;
    }
    
    const user = users[0];
    
    // Check password based on role
    const correctPasswords = {
      'rga': 'Sosiska1',
      'employee': 'Sosiska2'
    };
    
    const expectedPassword = correctPasswords[user.role];
    if (!expectedPassword || password !== expectedPassword) {
      res.status(401).json({ error: 'Invalid email or password' });
      return;
    }
    
    res.status(200).json({ 
      ok: true, 
      message: 'Login successful',
      role: user.role,
      email: user.email
    });
    
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/check-email.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email } = req.body || {};
    
    if (!email) {
      res.status(400).json({ error: 'Email is required' });
      return;
    }
    
    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';
    
    // Check if email exists in users table
    const response = await fetch(`${SUPABASE_URL}/rest/v1/users?email=eq.${encodeURIComponent(email)}&select=email`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    if (!response.ok) {
      console.error('Supabase error:', await response.text());
      res.status(500).json({ error: 'Database error' });
      return;
    }
    
    const users = await response.json();
    const exists = users && users.length > 0;
    
    res.status(200).json({ exists });
    
  } catch (error) {
    console.error('Check email error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/send-code.js
================================================================================

export default async function handler(req, res) {
  console.log('=== SEND CODE API CALLED ===');
  console.log('Method:', req.method);
  console.log('Body:', req.body);
  
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email } = req.body || {};
    if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
      res.status(400).json({ error: 'Valid email is required' });
      return;
    }

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    const code = Math.floor(100000 + Math.random() * 900000).toString();
    const expires = new Date(Date.now() + 10 * 60 * 1000).toISOString();

    // Upsert code for this email
    const upsertResp = await fetch(`${SUPABASE_URL}/rest/v1/email_codes`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Prefer': 'resolution=merge-duplicates'
      },
      body: JSON.stringify([{ email, code, expires_at: expires, used: false }])
    });

    if (!upsertResp.ok) {
      const err = await upsertResp.json().catch(() => ({}));
      res.status(500).json({ error: 'Failed to save code', details: err });
      return;
    }

    const RESEND_API_KEY = process.env.RESEND_API_KEY;
    
    console.log('RESEND_API_KEY exists:', !!RESEND_API_KEY);
    console.log('RESEND_API_KEY length:', RESEND_API_KEY ? RESEND_API_KEY.length : 0);
    
    // Always try to send email first, with better error handling
    if (RESEND_API_KEY) {
      try {
        const emailResp = await fetch('https://api.resend.com/emails', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${RESEND_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            from: 'Audit PharmaT <code@pharmataudit.online>',
            to: [email],
            subject: 'Your PharmaT verification code',
            html: `
              <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #2d5a27;">PharmaT Audit Verification</h2>
                <p>Your verification code is:</p>
                <div style="background: #f5f5f5; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; color: #2d5a27; border-radius: 8px; margin: 20px 0;">
                  ${code}
                </div>
                <p>This code expires in 10 minutes.</p>
                <p>If you didn't request this code, please ignore this email.</p>
              </div>
            `,
            text: `Your PharmaT verification code is: ${code}. It expires in 10 minutes.`
          })
        });
        
        const emailJson = await emailResp.json().catch(() => ({}));
        
        if (emailResp.ok) {
          console.log('Email sent successfully:', emailJson);
          res.status(200).json({ 
            ok: true, 
            id: emailJson?.id,
            message: 'Verification code sent to your email',
            emailSent: true
          });
          return;
        } else {
          console.error('Email sending failed:', emailJson);
          // Don't fail completely, show dev code as fallback
          res.status(200).json({ 
            ok: true, 
            devCode: code, 
            emailError: emailJson,
            note: 'Email sending failed, showing code for testing. Check email configuration.'
          });
          return;
        }
      } catch (emailError) {
        console.error('Email service error:', emailError);
        // Don't fail completely, show dev code as fallback
        res.status(200).json({ 
          ok: true, 
          devCode: code, 
          emailError: emailError.message,
          note: 'Email service unavailable, showing code for testing.'
        });
        return;
      }
    }

    // Dev fallback when email provider not configured
    console.log('Using dev fallback - no RESEND_API_KEY or email failed');
    console.log('Generated code:', code);
    res.status(200).json({ 
      ok: true, 
      devCode: code, 
      message: 'Development mode - code shown below',
      note: 'Email provider not configured. Set RESEND_API_KEY environment variable to enable email sending.',
      setupInstructions: [
        '1. Sign up for Resend at https://resend.com',
        '2. Get your API key from the dashboard',
        '3. Set RESEND_API_KEY environment variable',
        '4. Add test emails in Resend settings if using onboarding@resend.dev'
      ]
    });
  } catch (error) {
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/verify-code.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email, code } = req.body || {};
    if (!email || !code) {
      res.status(400).json({ error: 'Email and code are required' });
      return;
    }

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    // Lookup code with better error handling
    const lookupUrl = `${SUPABASE_URL}/rest/v1/email_codes?email=eq.${encodeURIComponent(email)}&code=eq.${encodeURIComponent(code)}&used=eq.false&select=*`;
    
    console.log('Looking up code for email:', email);
    
    const resp = await fetch(lookupUrl, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    const rows = await resp.json();
    
    if (!resp.ok) {
      console.error('Supabase lookup failed:', rows);
      res.status(resp.status).json({ 
        error: rows?.message || 'Database lookup failed', 
        details: rows 
      });
      return;
    }

    console.log('Found rows:', rows.length);

    if (!Array.isArray(rows) || rows.length === 0) {
      console.log('No matching code found for email:', email);
      res.status(400).json({ 
        error: 'Invalid or expired code',
        hint: 'Make sure you entered the correct 6-digit code'
      });
      return;
    }

    const row = rows[0];
    const now = new Date();
    const expiresAt = new Date(row.expires_at);
    
    console.log('Code expires at:', expiresAt);
    console.log('Current time:', now);
    
    if (expiresAt < now) {
      console.log('Code has expired');
      res.status(400).json({ 
        error: 'Code expired',
        hint: 'Please request a new verification code'
      });
      return;
    }

    // Mark used
    await fetch(`${SUPABASE_URL}/rest/v1/email_codes?email=eq.${encodeURIComponent(email)}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ used: true })
    });

    res.status(200).json({ ok: true });
  } catch (error) {
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/get-profile.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email } = req.query || {};
    if (!email) {
      res.status(400).json({ error: 'Email is required' });
      return;
    }

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    const response = await fetch(`${SUPABASE_URL}/rest/v1/profiles?email=eq.${encodeURIComponent(email)}&select=*`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });

    if (!response.ok) {
      const text = await response.text();
      console.error('Supabase get-profile error:', text);
      res.status(500).json({ error: 'Failed to fetch profile' });
      return;
    }

    const profiles = await response.json();
    if (!profiles || profiles.length === 0) {
      res.status(200).json({ ok: true, profile: null });
      return;
    }

    res.status(200).json({ ok: true, profile: profiles[0] });
  } catch (error) {
    console.error('Get profile error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/save-profile.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const {
      firstName: camelFirstName,
      lastName: camelLastName,
      pharmacies,
      role,
      email,
      first_name: snakeFirstName,
      last_name: snakeLastName
    } = req.body || {};
    
    const firstName = camelFirstName || snakeFirstName || '';
    const lastName = camelLastName || snakeLastName || '';
    
    // Validate required fields
    const sanitizedPharmacies = Array.isArray(pharmacies)
      ? pharmacies.map(({ index, region, address, phone, hours }) => ({
          index,
          region,
          address,
          phone,
          hours
        })).filter(p => typeof p.index !== 'undefined')
      : [];
    
    if (!firstName || !lastName || sanitizedPharmacies.length === 0) {
      res.status(400).json({ error: 'All fields are required' });
      return;
    }
    
    // Validate role
    if (!['employee', 'rga'].includes(role)) {
      res.status(400).json({ error: 'Invalid role' });
      return;
    }
    
    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';
    
    // Validate pharmacy count based on role
    const pharmacyLimits = {
      'employee': 1,
      'rga': 5
    };
    
    const maxPharmacies = pharmacyLimits[role];
    if (sanitizedPharmacies.length > maxPharmacies) {
      res.status(400).json({ 
        error: `Maximum ${maxPharmacies} pharmacy${maxPharmacies > 1 ? 'ies' : ''} allowed for ${role}` 
      });
      return;
    }
    
    // Save profile data to database
    const profileData = {
      first_name: firstName,
      last_name: lastName,
      pharmacies: sanitizedPharmacies,
      role,
      email,
      created_at: new Date().toISOString()
    };
    
    const response = await fetch(`${SUPABASE_URL}/rest/v1/profiles?on_conflict=email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation,resolution=merge-duplicates'
      },
      body: JSON.stringify(profileData)
    });
    
    const supabaseRaw = await response.text();
    let supabaseJson = null;
    if (supabaseRaw) {
      try {
        supabaseJson = JSON.parse(supabaseRaw);
      } catch (parseErr) {
        console.error('Supabase response parse error:', parseErr, supabaseRaw);
      }
    }
    
    if (!response.ok) {
      console.error('Supabase error:', response.status, supabaseJson || supabaseRaw);
      const message = supabaseJson?.message || supabaseJson?.error || supabaseRaw || 'Failed to save profile';
      res.status(response.status || 500).json({ 
        error: message 
      });
      return;
    }
    
    res.status(200).json({ 
      ok: true, 
      message: 'Profile saved successfully',
      profile: {
        firstName,
        lastName,
        pharmacies: sanitizedPharmacies,
        role,
        email,
        supabase: supabaseJson
      }
    });
    
  } catch (error) {
    console.error('Save profile error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/get-submissions.js
================================================================================

function buildInFilter(values = []) {
  const sanitized = values
    .map(v => `${v}`.trim())
    .filter(Boolean)
    .map(v => encodeURIComponent(v));
  if (!sanitized.length) return null;
  return `(${sanitized.join(',')})`;
}

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email, pharmacies, role } = req.query || {};

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    let url = `${SUPABASE_URL}/rest/v1/task_submissions?select=*`;

    if (email && (!role || role === 'employee')) {
      url += `&employee_email=eq.${encodeURIComponent(email)}`;
    }

    if (pharmacies) {
      const inFilter = buildInFilter(Array.isArray(pharmacies) ? pharmacies : `${pharmacies}`.split(','));
      if (inFilter) {
        url += `&pharmacy_index=in.${inFilter}`;
      }
    }

    url += '&order=updated_at.desc';

    const response = await fetch(url, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });

    if (!response.ok) {
      const text = await response.text();
      console.error('Supabase get-submissions error:', text);
      res.status(500).json({ error: 'Failed to fetch submissions' });
      return;
    }

    const submissions = await response.json();
    res.status(200).json({ ok: true, submissions });
  } catch (error) {
    console.error('Get submissions error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/save-submission.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email, pharmacyIndex, taskKey, fileName, fileUrl } = req.body || {};

    if (!email || pharmacyIndex === undefined || !taskKey || !fileUrl) {
      res.status(400).json({ error: 'Missing required fields' });
      return;
    }

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    const payload = [{
      employee_email: email,
      pharmacy_index: pharmacyIndex,
      task_key: taskKey,
      status: 'waiting',
      file_name: fileName || '',
      file_url: fileUrl,
      updated_at: new Date().toISOString()
    }];

    const response = await fetch(`${SUPABASE_URL}/rest/v1/task_submissions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation,resolution=merge-duplicates'
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const text = await response.text();
      console.error('Supabase save-submission error:', text);
      res.status(500).json({ error: 'Failed to save submission' });
      return;
    }

    const result = await response.json();
    res.status(200).json({ ok: true, submission: result?.[0] });
  } catch (error) {
    console.error('Save submission error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/delete-submission.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { email, pharmacyIndex, taskKey } = req.body || {};

    if (!email || pharmacyIndex === undefined || !taskKey) {
      res.status(400).json({ error: 'Missing required fields' });
      return;
    }

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    const url = `${SUPABASE_URL}/rest/v1/task_submissions?employee_email=eq.${encodeURIComponent(email)}&pharmacy_index=eq.${encodeURIComponent(pharmacyIndex)}&task_key=eq.${encodeURIComponent(taskKey)}`;

    const response = await fetch(url, {
      method: 'DELETE',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation'
      }
    });

    if (!response.ok) {
      const text = await response.text();
      console.error('Supabase delete-submission error:', text);
      res.status(500).json({ error: 'Failed to delete submission' });
      return;
    }

    res.status(200).json({ ok: true });
  } catch (error) {
    console.error('Delete submission error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
FILE: api/update-submission-status.js
================================================================================

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { employeeEmail, pharmacyIndex, taskKey, status, reviewerEmail } = req.body || {};

    if (!employeeEmail || pharmacyIndex === undefined || !taskKey || !status) {
      res.status(400).json({ error: 'Missing required fields' });
      return;
    }

    const SUPABASE_URL = 'https://xsrppkeysfjkxkbpfbog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcnBwa2V5c2Zqa3hrYnBmYm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDI2NjcsImV4cCI6MjA3NDkxODY2N30.sLZtdQ80_Q-OlX7wD4bDoaLEVOBBMF7Qfga_Ju299t8';

    const url = `${SUPABASE_URL}/rest/v1/task_submissions?employee_email=eq.${encodeURIComponent(employeeEmail)}&pharmacy_index=eq.${encodeURIComponent(pharmacyIndex)}&task_key=eq.${encodeURIComponent(taskKey)}`;

    const payload = {
      status,
      reviewer_email: reviewerEmail || null,
      reviewed_at: new Date().toISOString()
    };

    const response = await fetch(url, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const text = await response.text();
      console.error('Supabase update-submission-status error:', text);
      res.status(500).json({ error: 'Failed to update submission status' });
      return;
    }

    const result = await response.json();
    res.status(200).json({ ok: true, submission: result?.[0] });
  } catch (error) {
    console.error('Update submission status error:', error);
    res.status(500).json({ error: error.message || 'Unexpected server error' });
  }
}

================================================================================
END OF CODE FILES
================================================================================

NOTE: The files profile.html, welcome.html, and rga-dashboard.html are very long 
(over 1000 lines each). Their full content is available in the respective files.
This consolidated file includes all API endpoints and the complete code for 
index.html, register.html, and audit.html.

To get the complete code for profile.html, welcome.html, and rga-dashboard.html,
please refer to those individual files or ask GPT to read them separately.

================================================================================

