<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | Audit PharmaT RU</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 450px;
    }
    
    h2 {
      color: #2d5a27;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
    }
    
    label {
      display: block;
      margin-bottom: 15px;
      color: #333;
      font-weight: 500;
    }
    
    select, input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }
    
    button:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .error {
      color: #f44336;
      background: #ffebee;
      padding: 10px 15px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 4px solid #f44336;
      font-size: 14px;
    }
    
    .hidden { display: none; }
    
    .form-group {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <button id="loginBtnTop" style="background: none; color: #666; border: none; padding: 4px 8px; cursor: pointer; font-size: 14px; text-decoration: underline;">
        –í–æ–π—Ç–∏
      </button>
    </div>
    <form id="step1Form">
      <div class="form-group">
        <label>
          –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:
          <select id="roleSelect" required>
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
            <option value="employee">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</option>
            <option value="rga">–†–ì–ê</option>
          </select>
        </label>
      </div>
      
      <div class="form-group">
        <label>
          Email:
          <input type="email" id="emailInput" required placeholder="example@company.ru" />
        </label>
        <button type="button" id="sendCodeBtn" style="margin-top:10px; width:100%">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</button>
      </div>

      <div class="form-group hidden" id="codeGroup">
        <label>
          –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞:
          <input type="text" id="codeInput" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" maxlength="6" pattern="[0-9]{6}" />
        </label>
        <button type="button" id="verifyCodeBtn" style="margin-top:10px; width:100%">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
        <div id="verifyMsg" class="error" style="display:none"></div>
      </div>
      
      <div class="form-group">
        <label>
          –ü–∞—Ä–æ–ª—å:
          <div style="position: relative;">
            <input type="password" id="passportInput" required style="padding-right: 40px; width: 100%;" />
            <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-80%); background: none; border: none; cursor: pointer; padding: 4px; color: #666; font-size: 18px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
              üëÅ
            </button>
          </div>
        </label>
      </div>
      
      <div id="errorMsg" class="error" style="display: none;"></div>
      <button type="submit">–î–∞–ª–µ–µ</button>
    </form>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; margin: 20px; position: relative;">
      <button id="closeLoginModal" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; z-index: 10;">&times;</button>
      <div style="margin-bottom: 30px; text-align: center;">
        <h2 style="margin: 0; color: #2d5a27;">–í—Ö–æ–¥</h2>
      </div>
      
      <form id="loginForm">
        <div class="form-group">
          <label>
            Email:
            <input type="email" id="loginEmail" required placeholder="example@company.ru" />
          </label>
        </div>
        
        <div class="form-group">
          <label>
            –ü–∞—Ä–æ–ª—å:
            <div style="position: relative;">
              <input type="password" id="loginPassword" required style="padding-right: 40px; width: 100%;" />
              <button type="button" id="toggleLoginPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-80%); background: none; border: none; cursor: pointer; padding: 4px; color: #666; font-size: 18px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                üëÅ
              </button>
            </div>
          </label>
        </div>
        
        <div id="loginErrorMsg" class="error" style="display: none;"></div>
        <button type="submit" style="width: 100%;">–í–æ–π—Ç–∏</button>
      </form>
    </div>
  </div>

  <script>
    // Note: Supabase client library removed as it's not used
    // All database operations go through API endpoints (/api/*)
    
    const step1Form = document.getElementById('step1Form');
    const errorMsg = document.getElementById('errorMsg');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const codeGroup = document.getElementById('codeGroup');
    const verifyMsg = document.getElementById('verifyMsg');
    const codeInput = document.getElementById('codeInput');
    const passportInput = document.getElementById('passportInput');
    const togglePassword = document.getElementById('togglePassword');
    const loginModal = document.getElementById('loginModal');
    const loginBtnTop = document.getElementById('loginBtnTop');
    const closeLoginModal = document.getElementById('closeLoginModal');
    const loginForm = document.getElementById('loginForm');
    const loginErrorMsg = document.getElementById('loginErrorMsg');
    const loginPassword = document.getElementById('loginPassword');
    const toggleLoginPassword = document.getElementById('toggleLoginPassword');

    // Password requirements
    const correctPasswords = {
      'rga': 'Sosiska1',
      'employee': 'Sosiska2'
    };

    // Restrict code input to only numbers and max 6 digits
    codeInput.addEventListener('input', function(e) {
      // Remove any non-numeric characters
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
      // Limit to 6 digits
      if (e.target.value.length > 6) {
        e.target.value = e.target.value.slice(0, 6);
      }
    });

    // Prevent non-numeric input
    codeInput.addEventListener('keypress', function(e) {
      if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
      }
    });

    // Password visibility toggle
    togglePassword.addEventListener('click', function() {
      if (passportInput.type === 'password') {
        passportInput.type = 'text';
        togglePassword.textContent = 'üôà';
      } else {
        passportInput.type = 'password';
        togglePassword.textContent = 'üëÅ';
      }
    });

    // Login modal functionality
    loginBtnTop.addEventListener('click', function() {
      loginModal.style.display = 'flex';
      loginModal.style.alignItems = 'center';
      loginModal.style.justifyContent = 'center';
    });

    closeLoginModal.addEventListener('click', function() {
      loginModal.style.display = 'none';
      loginErrorMsg.style.display = 'none';
      loginForm.reset();
    });

    // Close modal when clicking outside
    loginModal.addEventListener('click', function(e) {
      if (e.target === loginModal) {
        loginModal.style.display = 'none';
        loginErrorMsg.style.display = 'none';
        loginForm.reset();
      }
    });

    // Login password visibility toggle
    toggleLoginPassword.addEventListener('click', function() {
      if (loginPassword.type === 'password') {
        loginPassword.type = 'text';
        toggleLoginPassword.textContent = 'üôà';
      } else {
        loginPassword.type = 'password';
        toggleLoginPassword.textContent = 'üëÅ';
      }
    });
    
    // Force deployment trigger
    console.log('–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

    step1Form.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent form submission to server
      
      errorMsg.textContent = ''; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏

      const role = document.getElementById('roleSelect').value;
      const email = document.getElementById('emailInput').value.trim();
      const passport = document.getElementById('passportInput').value.trim();

      // Validate role selected
      if (!role) {
        errorMsg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å.';
        return;
      }

      // Validate email format (HTML5 email type input handles basic check)
      if (!email) {
        errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã.';
        return;
      }

      // Validate passport matches the required password for the role
      if (!passport || passport.trim() === '') {
        errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.';
        return;
      }

      const requiredPassword = correctPasswords[role];
      if (passport !== requiredPassword) {
        errorMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏.';
        return;
      }

      // Ensure email verified before proceeding
      const isVerified = codeGroup.dataset.verified === 'true';
      if (!isVerified) {
        errorMsg.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ—á—Ç—É —Å –ø–æ–º–æ—â—å—é –∫–æ–¥–∞.';
        errorMsg.style.display = 'block';
        return;
      }

      // If all validations pass, save to database
      console.log('–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
      saveUserToDatabase(role, email);
    });

    // Send verification code
    sendCodeBtn.addEventListener('click', async () => {
      console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...');
      const email = document.getElementById('emailInput').value.trim();
      errorMsg.style.display = 'none';
      verifyMsg.style.display = 'none';
      codeGroup.dataset.verified = 'false';
      
      if (!email) {
        errorMsg.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ email.';
        errorMsg.style.display = 'block';
        return;
      }
      
      console.log('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞ –Ω–∞ email:', email);
      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
      
      // Check if email is already registered
      try {
        const checkEmailResponse = await fetch('/api/check-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const emailCheckResult = await checkEmailResponse.json();
        if (emailCheckResult.exists) {
          errorMsg.innerHTML = `
            <div style="text-align: center;">
              <p style="margin: 0 0 15px 0; font-weight: 600; color: #f44336;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</p>
              <button type="button" id="loginBtnFromError" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                –í–æ–π—Ç–∏
              </button>
            </div>
          `;
          errorMsg.style.display = 'block';
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
          return;
        }
      } catch (emailCheckError) {
        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ email –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º:', emailCheckError);
      }
      
      try {
        const resp = await fetch('/api/send-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const result = await resp.json();
        
        if (!resp.ok) {
          throw new Error(result?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥');
        }
        
        // Show the code input section
        codeGroup.classList.remove('hidden');
        verifyMsg.style.display = 'block';
        
        // Handle different response scenarios
        console.log('–û—Ç–≤–µ—Ç API –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞:', result);
        
        if (result?.devCode) {
          // Development mode - show the code
          verifyMsg.style.background = '#fff3cd';
          verifyMsg.style.color = '#856404';
          verifyMsg.style.borderLeft = '4px solid #ffc107';
          verifyMsg.innerHTML = `
            <strong>–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:</strong><br>
            –û—Ç–ø—Ä–∞–≤–∫–∞ email –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –í–∞—à –∫–æ–¥: <strong>${result.devCode}</strong><br>
            <small>${result.note || ''}</small>
          `;
          
          if (result.setupInstructions) {
            verifyMsg.innerHTML += '<br><br><strong>–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –ø–∏—Å–µ–º:</strong><br>' + 
              result.setupInstructions.map(instruction => `<small>‚Ä¢ ${instruction}</small>`).join('<br>');
          }
        } else if (result?.ok === true) {
          // Email sent successfully
          verifyMsg.style.background = '#d4edda';
          verifyMsg.style.color = '#155724';
          verifyMsg.style.borderLeft = '4px solid #28a745';
          verifyMsg.textContent = '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É.';
        } else if (result?.emailError) {
          // Email sending failed but we have a fallback code
          verifyMsg.style.background = '#fff3cd';
          verifyMsg.style.color = '#856404';
          verifyMsg.style.borderLeft = '4px solid #ffc107';
          verifyMsg.innerHTML = `
            <strong>–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email:</strong><br>
            –í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: <strong>${result.devCode}</strong><br>
            <small>${result.note || ''}</small>
          `;
        } else {
          // Email sent successfully
          verifyMsg.style.background = '#d4edda';
          verifyMsg.style.color = '#155724';
          verifyMsg.style.borderLeft = '4px solid #28a745';
          verifyMsg.textContent = result.message || '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É.';
        }
        
      } catch (e) {
        errorMsg.textContent = e.message;
        errorMsg.style.display = 'block';
      } finally {
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
      }
    });

    // Verify code
    verifyCodeBtn.addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      const code = document.getElementById('codeInput').value.trim();
      verifyMsg.style.display = 'none';
      if (!email || !code) {
        verifyMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –ø–æ—á—Ç—É.';
        verifyMsg.style.display = 'block';
        return;
      }
      
      // Validate code is exactly 6 digits
      if (!/^[0-9]{6}$/.test(code)) {
        verifyMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥.';
        verifyMsg.style.display = 'block';
        return;
      }
      verifyCodeBtn.disabled = true;
      verifyCodeBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
      try {
        const resp = await fetch('/api/verify-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code })
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥');
        codeGroup.dataset.verified = 'true';
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#e8f5e8';
        verifyMsg.style.color = '#2d5a27';
        verifyMsg.textContent = 'Email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.';
      } catch (e) {
        verifyMsg.style.display = 'block';
        verifyMsg.textContent = e.message;
        codeGroup.dataset.verified = 'false';
      } finally {
        verifyCodeBtn.disabled = false;
        verifyCodeBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥';
      }
    });

    // Function to save user data to Supabase
    async function saveUserToDatabase(role, email) {
      try {
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
        submitBtn.disabled = true;

        console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', { role, email });

        // Call serverless API to avoid CORS/network issues
        const apiResponse = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role, email })
        });

        const result = await apiResponse.json();
        if (!apiResponse.ok) {
          console.error('API error:', result);
          throw new Error(result?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }

        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω —á–µ—Ä–µ–∑ API:', result);
        
        // Store user role for profile completion
        sessionStorage.setItem('userRole', role);
        sessionStorage.setItem('userEmail', email);
        
        // Success - proceed to profile completion
        alert(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n–†–æ–ª—å: ${role === 'rga' ? '–†–ì–ê' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'}\nEmail: ${email}\n–¢–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.`);
        
        // Redirect to profile completion page
        window.location.href = `profile.html?role=${role}&email=${email}`;

      } catch (err) {
        console.error('Registration error:', err);
        
        // Check if it's a duplicate email error
        if (err.message.includes('duplicate key value violates unique constraint') || 
            err.message.includes('users_email_key') ||
            err.message.includes('duplicate')) {
          errorMsg.innerHTML = `
            <div style="text-align: center;">
              <p style="margin: 0 0 15px 0; font-weight: 600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</p>
              <button type="button" id="loginBtn" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                –í–æ–π—Ç–∏
              </button>
            </div>
          `;
        } else {
          errorMsg.textContent = `–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${err.message}`;
        }
        errorMsg.style.display = 'block';
      } finally {
        // Reset button state
        const submitBtn = document.querySelector('button[type="submit"]');
        submitBtn.textContent = '–î–∞–ª–µ–µ';
        submitBtn.disabled = false;
      }
    }
    
    // Handle Log In button click
    document.addEventListener('click', function(e) {
      if (e.target.id === 'loginBtn' || e.target.id === 'loginBtnFromError') {
        loginModal.style.display = 'flex';
      }
    });

    // Login form submission
    loginForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      
      loginErrorMsg.style.display = 'none';
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      
      if (!email || !password) {
        loginErrorMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.';
        loginErrorMsg.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          try {
            sessionStorage.setItem('userRole', result.role);
            sessionStorage.setItem('userEmail', email);
          } catch (storageErr) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏', storageErr);
          }

          try {
            const profileResponse = await fetch(`/api/get-profile?email=${encodeURIComponent(email)}`);
            if (profileResponse.ok) {
              const profilePayload = await profileResponse.json();
              if (profilePayload?.profile) {
                try {
                  sessionStorage.setItem('profileFormData', JSON.stringify(profilePayload.profile));
                } catch (cacheErr) {
                  console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ –∫—ç—à–µ', cacheErr);
                }
                if ((result.role || '').toLowerCase() === 'rga') {
                  window.location.href = 'rga-dashboard.html';
                } else {
                  window.location.href = 'welcome.html';
                }
                return;
              }
            }
          } catch (profileErr) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ –≤—Ö–æ–¥–µ', profileErr);
          }

          try {
            sessionStorage.removeItem('profileFormData');
          } catch (clearErr) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –ø—Ä–æ—Ñ–∏–ª—è', clearErr);
          }
          window.location.href = `profile.html?role=${encodeURIComponent(result.role)}&email=${encodeURIComponent(email)}`;
        } else {
          loginErrorMsg.textContent = result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ö–æ–¥.';
          loginErrorMsg.style.display = 'block';
        }
      } catch (error) {
        loginErrorMsg.textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
        loginErrorMsg.style.display = 'block';
      }
    });
    
  </script>
</body>
</html>
