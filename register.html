<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Registration Step 1</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 450px;
    }

    .welcome-heading {
      margin: 0 0 8px;
      color: #2d5a27;
      font-size: 28px;
      text-align: center;
    }

    .welcome-text {
      margin: 0 0 24px;
      color: #666;
      text-align: center;
      font-size: 15px;
    }

    h2 {
      color: #2d5a27;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
    }

    label {
      display: block;
      margin-bottom: 15px;
      color: #333;
      font-weight: 500;
    }

    select, input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }

    button:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .error {
      color: #f44336;
      background: #ffebee;
      padding: 10px 15px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 4px solid #f44336;
      font-size: 14px;
    }

    .hidden { display: none; }

    .form-group {
      margin-bottom: 20px;
    }

    /* Password show/hide button */
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none !important;
      border: none;
      cursor: pointer;
      padding: 2px 6px !important;
      color: #888;
      font-size: 12px;
      font-weight: 500;
      width: auto !important;
      margin: 0 !important;
      border-radius: 4px;
      min-height: auto;
    }

    /* Login section at the bottom of the form */
    .login-footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .login-footer p {
      color: #666;
      margin-bottom: 12px;
      font-size: 14px;
    }

    #loginBtnBottom {
      background: #4A90D9;
      color: #ffffff;
    }

    #loginBtnBottom:hover {
      background: #3A7BC8;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    #loginBtnBottom:active {
      transform: translateY(0);
    }

    /* Login modal overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    /* Login modal box */
    .modal-box {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      margin: 20px;
    }

    .modal-box h2 {
      margin: 0 0 30px;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 12px;
      }

      .container {
        padding: 28px 24px;
        border-radius: 12px;
      }

      h2 {
        font-size: 24px;
        margin-bottom: 24px;
      }

      label {
        margin-bottom: 12px;
        font-size: 15px;
      }

      select, input {
        padding: 14px 16px;
        font-size: 16px;
        min-height: 48px;
      }

      button {
        padding: 16px 24px;
        font-size: 17px;
        min-height: 48px;
      }

      .modal-box {
        margin: 16px;
        padding: 28px 24px;
        max-width: calc(100% - 32px);
      }

      #togglePassword, #toggleLoginPassword {
        min-width: 44px;
        min-height: 44px;
        font-size: 20px;
      }

      .error {
        padding: 12px 16px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px 8px;
      }

      .container {
        padding: 24px 20px;
      }

      h2 {
        font-size: 22px;
      }

      select, input {
        padding: 16px;
        font-size: 16px;
      }

      button {
        padding: 18px 20px;
        font-size: 18px;
      }

      .modal-box {
        padding: 24px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="welcome-heading">Welcome to the PharmaT Audit!</h1>
    <p class="welcome-text">Please, register to continue.</p>
    <form id="step1Form">
      <div class="form-group">
        <label>
          Select your role:
          <select id="roleSelect" required>
            <option value="" disabled selected>Select role</option>
            <option value="employee">Employee</option>
            <option value="rga">RGA</option>
          </select>
        </label>
      </div>

      <div class="form-group">
        <label>
          Email:
          <input type="email" id="emailInput" required>
        </label>
        <button type="button" id="sendCodeBtn" style="margin-top: 10px;">Send verification code</button>
      </div>

      <div class="form-group hidden" id="codeGroup">
        <label>
          Enter code from email:
          <input type="text" id="codeInput" placeholder="6-digit code" maxlength="6" pattern="[0-9]{6}" />
        </label>
        <button type="button" id="verifyCodeBtn" style="margin-top: 10px;">Verify code</button>
        <div id="verifyMsg" class="error" style="display: none;"></div>
      </div>

      <div class="form-group">
        <label>
          Password:
          <div style="position: relative;">
            <input type="password" id="passportInput" required style="padding-right: 40px;" />
            <button type="button" id="togglePassword" class="password-toggle">Show</button>
          </div>
        </label>
      </div>

      <div id="errorMsg" class="error" style="display: none;"></div>
      <button type="submit">Next</button>

      <div class="login-footer">
        <p>Already a user?</p>
        <button type="button" id="loginBtnBottom">Log In</button>
      </div>
    </form>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal-overlay">
    <div class="modal-box">
      <h2>Log In</h2>

      <form id="loginForm">
        <div class="form-group">
          <label>
            Email:
            <input type="email" id="loginEmail" required>
          </label>
        </div>

        <div class="form-group">
          <label>
            Password:
            <div style="position: relative;">
              <input type="password" id="loginPassword" required style="padding-right: 40px;" />
              <button type="button" id="toggleLoginPassword" class="password-toggle">Show</button>
            </div>
          </label>
        </div>

        <div id="loginErrorMsg" class="error" style="display: none;"></div>
        <button type="submit">Log In</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="app.js"></script>
  <script>
    // Get all the elements from the page
    const step1Form = document.getElementById('step1Form');
    const errorMsg = document.getElementById('errorMsg');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const codeGroup = document.getElementById('codeGroup');
    const verifyMsg = document.getElementById('verifyMsg');
    const codeInput = document.getElementById('codeInput');
    const passportInput = document.getElementById('passportInput');
    const togglePassword = document.getElementById('togglePassword');
    const loginModal = document.getElementById('loginModal');
    const loginBtnBottom = document.getElementById('loginBtnBottom');
    const loginForm = document.getElementById('loginForm');
    const loginErrorMsg = document.getElementById('loginErrorMsg');
    const loginPassword = document.getElementById('loginPassword');
    const toggleLoginPassword = document.getElementById('toggleLoginPassword');

    // Only allow numbers in the code input, max 6 digits
    codeInput.addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
      if (e.target.value.length > 6) {
        e.target.value = e.target.value.slice(0, 6);
      }
    });

    // Block non-number keys in the code input
    codeInput.addEventListener('keypress', function(e) {
      if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
      }
    });

    // Toggle password visibility on the registration form
    togglePassword.addEventListener('click', function() {
      if (passportInput.type === 'password') {
        passportInput.type = 'text';
        togglePassword.textContent = 'Hide';
      } else {
        passportInput.type = 'password';
        togglePassword.textContent = 'Show';
      }
    });

    // Toggle password visibility on the login form
    toggleLoginPassword.addEventListener('click', function() {
      if (loginPassword.type === 'password') {
        loginPassword.type = 'text';
        toggleLoginPassword.textContent = 'Hide';
      } else {
        loginPassword.type = 'password';
        toggleLoginPassword.textContent = 'Show';
      }
    });

    // Open the login modal
    function openLoginModal() {
      loginModal.style.display = 'flex';
    }

    // Close the login modal and reset the form
    function closeLoginModal() {
      loginModal.style.display = 'none';
      loginErrorMsg.style.display = 'none';
      loginForm.reset();
    }

    // Open login modal when the Log In button is clicked
    loginBtnBottom.addEventListener('click', openLoginModal);

    // Close modal when clicking outside the white box
    loginModal.addEventListener('click', function(e) {
      if (e.target === loginModal) {
        closeLoginModal();
      }
    });

    // Handle registration form submission
    step1Form.addEventListener('submit', function(event) {
      event.preventDefault();
      errorMsg.style.display = 'none';

      const role = document.getElementById('roleSelect').value;
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passportInput').value.trim();

      // Check that a role is selected
      if (!role) {
        errorMsg.textContent = 'Please select a role.';
        errorMsg.style.display = 'block';
        return;
      }

      // Check that email is entered
      if (!email) {
        errorMsg.textContent = 'Please enter your email.';
        errorMsg.style.display = 'block';
        return;
      }

      // Check that password is entered
      if (!password) {
        errorMsg.textContent = 'Please enter a password.';
        errorMsg.style.display = 'block';
        return;
      }

      // Check that email has been verified
      if (codeGroup.dataset.verified !== 'true') {
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#fff3cd';
        verifyMsg.style.color = '#856404';
        verifyMsg.style.borderLeft = '4px solid #ffc107';
        verifyMsg.textContent = 'Please verify your email with the code before continuing.';
        return;
      }

      // All checks passed - save the user
      saveUserToDatabase(role, email, password);
    });

    // Send verification code to the user's email
    sendCodeBtn.addEventListener('click', async function() {
      const email = document.getElementById('emailInput').value.trim();
      errorMsg.style.display = 'none';
      verifyMsg.style.display = 'none';
      codeGroup.dataset.verified = 'false';

      if (!email) {
        errorMsg.textContent = 'Please enter your email first.';
        errorMsg.style.display = 'block';
        return;
      }

      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'Sending...';

      try {
        // First check if this email is already registered
        const checkResponse = await fetch('/api/check-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        });

        const checkResult = await checkResponse.json();
        if (checkResult.exists) {
          errorMsg.textContent = 'This email is already registered. Use the Log In button below.';
          errorMsg.style.display = 'block';
          return;
        }
      } catch (err) {
        // If email check fails, continue with sending the code anyway
      }

      try {
        // Send the verification code
        const response = await fetch('/api/send-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to send code');
        }

        // Show success message and the code input field
        codeGroup.classList.remove('hidden');
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#d4edda';
        verifyMsg.style.color = '#155724';
        verifyMsg.style.borderLeft = '4px solid #28a745';
        verifyMsg.textContent = 'Verification code sent to your email!';

      } catch (e) {
        errorMsg.textContent = e.message;
        errorMsg.style.display = 'block';
      }

      sendCodeBtn.disabled = false;
      sendCodeBtn.textContent = 'Send verification code';
    });

    // Verify the code the user entered
    verifyCodeBtn.addEventListener('click', async function() {
      const email = document.getElementById('emailInput').value.trim();
      const code = document.getElementById('codeInput').value.trim();
      verifyMsg.style.display = 'none';

      if (!email || !code) {
        verifyMsg.textContent = 'Enter the code sent to your email.';
        verifyMsg.style.display = 'block';
        return;
      }

      // Check that code is exactly 6 digits
      if (!/^[0-9]{6}$/.test(code)) {
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#fee2e2';
        verifyMsg.style.color = '#b91c1c';
        verifyMsg.style.borderLeft = '4px solid #fca5a5';
        verifyMsg.textContent = 'Please enter a valid 6-digit code.';
        return;
      }

      verifyCodeBtn.disabled = true;
      verifyCodeBtn.textContent = 'Verifying...';

      try {
        const response = await fetch('/api/verify-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email, code: code })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Verification failed');
        }

        // Code is correct - mark email as verified
        codeGroup.dataset.verified = 'true';
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#e8f5e8';
        verifyMsg.style.color = '#2d5a27';
        verifyMsg.textContent = 'Email verified successfully!';

      } catch (e) {
        verifyMsg.style.display = 'block';
        verifyMsg.style.background = '#fee2e2';
        verifyMsg.style.color = '#b91c1c';
        verifyMsg.style.borderLeft = '4px solid #fca5a5';
        verifyMsg.textContent = e.message;
        codeGroup.dataset.verified = 'false';
      }

      verifyCodeBtn.disabled = false;
      verifyCodeBtn.textContent = 'Verify code';
    });

    // Save user data to the database
    async function saveUserToDatabase(role, email, password) {
      const submitBtn = document.querySelector('button[type="submit"]');
      submitBtn.textContent = 'Saving...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: role, email: email, password: password })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Registration failed');
        }

        // Registration successful - go to profile page
        window.location.href = 'profile.html';

      } catch (err) {
        // Show error message to the user
        if (err.message.includes('duplicate') || err.message.includes('already registered')) {
          errorMsg.textContent = 'This email is already registered. Use the Log In button below.';
        } else {
          errorMsg.textContent = 'Registration failed: ' + err.message;
        }
        errorMsg.style.display = 'block';
      }

      submitBtn.textContent = 'Next';
      submitBtn.disabled = false;
    }

    // Handle login form submission
    loginForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      loginErrorMsg.style.display = 'none';

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      // Check that both fields are filled in
      if (!email || !password) {
        loginErrorMsg.textContent = 'Please fill in all fields.';
        loginErrorMsg.style.display = 'block';
        return;
      }

      try {
        // Send login request to the server
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email, password: password })
        });

        const result = await response.json();

        // If login failed, show the error message
        if (!response.ok) {
          loginErrorMsg.textContent = result.error || 'Login failed';
          loginErrorMsg.style.display = 'block';
          return;
        }

        // Login successful - check if user already has a profile
        try {
          const profileResponse = await fetch('/api/profile');
          if (profileResponse.ok) {
            const profileData = await profileResponse.json();
            if (profileData.profile) {
              // Profile exists - redirect based on role
              if (result.role && result.role.toLowerCase() === 'rga') {
                window.location.href = 'rga-dashboard.html';
              } else {
                window.location.href = 'employee.html';
              }
              return;
            }
          }
        } catch (err) {
          // If profile check fails, just go to profile page
        }

        // No profile yet - go to profile completion page
        window.location.href = 'profile.html';

      } catch (error) {
        loginErrorMsg.textContent = 'Login failed. Please check your connection.';
        loginErrorMsg.style.display = 'block';
      }
    });
  </script>
  <script src="cookie-consent.js"></script>
</body>
</html>
