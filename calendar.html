<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Calendar | PharmaT Audit</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #ffffff;
      margin: 0;
      min-height: 100vh;
      padding: 32px 20px 40px;
      color: #1f2933;
    }

    .top-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: #ffffff;
      border-radius: 16px;
      padding: 12px 18px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      margin: 0 auto 24px;
      max-width: 1200px;
    }

    .nav-brand {
      font-weight: 700;
      color: #2d5a27;
      font-size: 18px;
    }

    .nav-links {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .nav-link {
      text-decoration: none;
      color: #475569;
      font-weight: 600;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #f8fafc;
      transition: all 0.2s ease;
    }

    .nav-link:hover {
      color: #1d4ed8;
      border-color: #cbd5e1;
      background: #eef2ff;
    }

    .nav-link.active {
      color: #ffffff;
      background: #2d5a27;
      border-color: #2d5a27;
    }

    .calendar-page {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
      padding: 32px 36px 40px;
    }

    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 28px;
    }

    .page-header h1 {
      margin: 0;
      font-size: 28px;
      color: #2d5a27;
    }

    .page-header p {
      margin: 6px 0 0;
      color: #5f6c7b;
      font-size: 15px;
    }

    .filters {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filters label {
      font-size: 13px;
      color: #52606d;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filters select {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d1d9e6;
      font-size: 14px;
      min-width: 220px;
      background: #f8fafc;
    }

    .calendar-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr);
      gap: 24px;
    }

    .calendar-card {
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 20px;
      background: #f8fafc;
    }

    .calendar-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .month-label {
      font-weight: 700;
      font-size: 18px;
      color: #1f2933;
    }

    .calendar-nav-btn {
      border: 1px solid #cbd5e1;
      background: #ffffff;
      color: #1f2933;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .calendar-nav-btn:hover {
      background: #e2efff;
      transform: translateY(-1px);
    }

    .calendar-weekdays,
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
    }

    .weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      color: #52606d;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    .day-cell {
      min-height: 84px;
      border-radius: 12px;
      padding: 8px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .day-cell:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
    }

    .day-cell.is-empty {
      background: transparent;
      border-color: transparent;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .day-cell.is-selected {
      border-color: #2d5a27;
      box-shadow: inset 0 0 0 2px rgba(45, 90, 39, 0.2);
    }

    .day-number {
      font-weight: 700;
      font-size: 14px;
      color: #1f2933;
    }

    .day-events {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .event-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #94a3b8;
    }

    .event-dot.waiting {
      background: #f59e0b;
    }

    .event-dot.approved {
      background: #10b981;
    }

    .event-dot.rejected {
      background: #ef4444;
    }

    .event-count {
      font-size: 11px;
      color: #64748b;
    }

    .history-panel {
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 20px;
      background: #ffffff;
    }

    .history-panel h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #1f2933;
    }

    .history-item {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      background: #f8fafc;
    }

    .history-item:last-child {
      margin-bottom: 0;
    }

    .history-item h3 {
      margin: 0 0 6px;
      font-size: 15px;
      color: #1f2933;
    }

    .history-item p {
      margin: 0 0 6px;
      font-size: 12px;
      color: #52606d;
    }

    .history-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #475569;
    }

    .history-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .history-chip.waiting {
      background: #fff4ce;
      color: #b45309;
      border-color: #fcd34d;
    }

    .history-chip.approved {
      background: #d1fae5;
      color: #047857;
      border-color: #6ee7b7;
    }

    .history-chip.rejected {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fca5a5;
    }

    .history-actions {
      margin-top: 8px;
    }

    .history-actions a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      color: #1d4ed8;
      font-weight: 600;
      font-size: 12px;
    }

    .history-actions button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: none;
      background: transparent;
      color: #1d4ed8;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
    }

    .empty-state {
      color: #64748b;
      font-size: 14px;
      padding: 12px 0;
    }

    @media (max-width: 960px) {
      .calendar-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 12px 24px;
      }

      .top-nav {
        flex-direction: column;
        align-items: flex-start;
      }

      .calendar-page {
        padding: 24px 20px 28px;
      }

      .calendar-weekdays,
      .calendar-days {
        gap: 6px;
      }

      .day-cell {
        min-height: 70px;
      }
    }

    @media (max-width: 480px) {
      .calendar-page {
        padding: 20px 16px 24px;
      }

      .filters select {
        min-width: 180px;
      }
    }
  </style>
</head>
<body>
  <nav class="top-nav" aria-label="Primary">
    <div class="nav-brand">PharmaT Audit</div>
    <div class="nav-links">
      <a href="employee.html" class="nav-link" id="dashboardLink">Dashboard</a>
      <a href="calendar.html" class="nav-link active">Calendar</a>
    </div>
  </nav>

  <main class="calendar-page" style="display:none;" id="mainContent">
    <div class="page-header">
      <div>
        <h1>Submission Calendar</h1>
        <p id="pageSubtitle"></p>
      </div>
      <div class="filters">
        <label>
          Pharmacy
          <select id="pharmacyFilter"></select>
        </label>
      </div>
    </div>

    <section class="calendar-layout">
      <div class="calendar-card">
        <div class="calendar-toolbar">
          <button class="calendar-nav-btn" type="button" id="prevMonth">&larr;</button>
          <div class="month-label" id="monthLabel">Month</div>
          <button class="calendar-nav-btn" type="button" id="nextMonth">&rarr;</button>
        </div>
        <div class="calendar-weekdays" id="weekdayRow"></div>
        <div class="calendar-days" id="calendarDays"></div>
      </div>

      <aside class="history-panel">
        <h2 id="historyTitle">Events</h2>
        <div id="historyList" class="history-list"></div>
      </aside>
    </section>
  </main>

  <script>

    var DEFAULT_TASK_DEFINITIONS = [
      { key: 'window', title: 'Send photo of a window' },
      { key: 'trash', title: 'Send photo of trash cans' },
      { key: 'outfit', title: 'Send photo of an outfit' }
    ];

    var STATUS_LABELS = {
      not_submitted: 'Not submitted',
      waiting: 'Waiting for approval',
      approved: 'Approved',
      rejected: 'Not approved'
    };

    var MONTH_NAMES = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];

    var WEEKDAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];


    var TRANSLIT_MAP = {
      'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'e','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m',
      'н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'kh','ц':'ts','ч':'ch','ш':'sh','щ':'shch',
      'ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya',
      'А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'E','Ж':'Zh','З':'Z','И':'I','Й':'Y','К':'K','Л':'L','М':'M',
      'Н':'N','О':'O','П':'P','Р':'R','С':'S','Т':'T','У':'U','Ф':'F','Х':'Kh','Ц':'Ts','Ч':'Ch','Ш':'Sh','Щ':'Shch',
      'Ъ':'','Ы':'Y','Ь':'','Э':'E','Ю':'Yu','Я':'Ya'
    };


    var dashboardLink = document.getElementById('dashboardLink');
    var pharmacyFilter = document.getElementById('pharmacyFilter');
    var monthLabel = document.getElementById('monthLabel');
    var calendarDays = document.getElementById('calendarDays');
    var weekdayRow = document.getElementById('weekdayRow');
    var historyList = document.getElementById('historyList');
    var historyTitle = document.getElementById('historyTitle');
    var subtitleEl = document.getElementById('pageSubtitle');
    var prevMonthBtn = document.getElementById('prevMonth');
    var nextMonthBtn = document.getElementById('nextMonth');


    var currentMonth = new Date();
    currentMonth.setDate(1);
    var selectedDateKey = null;
    var submissions = [];
    var pharmacies = [];
    var role = '';
    var pharmacyLookup = {};
    var eventsByDate = {};
    var filteredPharmacyIndex = 'all';
    var taskTitles = {};
    var taskDefinitions = DEFAULT_TASK_DEFINITIONS;


    function getDateKey(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function parseDate(value) {
      if (!value) return null;
      var date = new Date(value);
      if (isNaN(date.getTime())) return null;
      return date;
    }

    function formatTime(date) {
      return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function transliterate(value) {
      if (!value) return '';
      var text = String(value);
      var result = '';
      for (var i = 0; i < text.length; i++) {
        var char = text[i];
        if (TRANSLIT_MAP[char] !== undefined) {
          result += TRANSLIT_MAP[char];
        } else {
          result += char;
        }
      }
      return result.replace(/\s+/g, ' ').trim();
    }

    function buildTaskTitles(definitions) {
      var result = {};
      for (var i = 0; i < definitions.length; i++) {
        var task = definitions[i];
        if (task && task.key) {
          result[task.key] = task.title || task.key;
        }
      }
      return result;
    }

    function buildPharmacyLabel(pharmacy) {
      var parts = [];
      if (pharmacy && pharmacy.region) parts.push(transliterate(pharmacy.region));
      if (pharmacy && pharmacy.address) parts.push(transliterate(pharmacy.address));
      if (parts.length > 0) return parts.join(' - ');
      return 'Pharmacy';
    }

    function getWeekdayOffset(date) {
      var day = date.getDay();
      return (day + 6) % 7;
    }


    function buildEvents(filteredSubmissions) {
      var events = [];

      for (var i = 0; i < filteredSubmissions.length; i++) {
        var item = filteredSubmissions[i];
        if (!item || item.pharmacy_index === undefined || item.pharmacy_index === null) {
          continue;
        }

        var status = item.status || 'waiting';
        if (status === 'not_submitted' && !item.file_url) {
          continue;
        }

        var pharmacyIndex = String(item.pharmacy_index);
        var pharmacyLabel = pharmacyLookup[pharmacyIndex] || ('Pharmacy #' + pharmacyIndex);
        var taskTitle = taskTitles[item.task_key] || item.task_key || 'Task';
        var updatedAt = parseDate(item.updated_at);
        var reviewedAt = parseDate(item.reviewed_at);

        if (updatedAt) {
          events.push({
            type: 'submission',
            status: status,
            date: updatedAt,
            pharmacyIndex: pharmacyIndex,
            pharmacyLabel: pharmacyLabel,
            taskTitle: taskTitle,
            fileName: item.file_name || '',
            fileUrl: item.file_url || '',
            employeeEmail: item.employee_email || '',
            reviewerEmail: item.reviewer_email || '',
            reviewNote: item.review_note || ''
          });
        }

        if (reviewedAt && (status === 'approved' || status === 'rejected')) {
          events.push({
            type: 'decision',
            status: status,
            date: reviewedAt,
            pharmacyIndex: pharmacyIndex,
            pharmacyLabel: pharmacyLabel,
            taskTitle: taskTitle,
            fileName: item.file_name || '',
            fileUrl: item.file_url || '',
            employeeEmail: item.employee_email || '',
            reviewerEmail: item.reviewer_email || '',
            reviewNote: item.review_note || ''
          });
        }
      }

      events.sort(function(a, b) {
        return b.date.getTime() - a.date.getTime();
      });

      return events;
    }

    function refreshEvents() {
      var filtered;
      if (filteredPharmacyIndex === 'all') {
        filtered = submissions;
      } else {
        filtered = [];
        for (var i = 0; i < submissions.length; i++) {
          if (String(submissions[i].pharmacy_index) === filteredPharmacyIndex) {
            filtered.push(submissions[i]);
          }
        }
      }

      var allEvents = buildEvents(filtered);
      eventsByDate = {};

      for (var i = 0; i < allEvents.length; i++) {
        var event = allEvents[i];
        var key = getDateKey(event.date);
        if (!eventsByDate[key]) {
          eventsByDate[key] = [];
        }
        eventsByDate[key].push(event);
      }
    }


    function renderWeekdays() {
      var html = '';
      for (var i = 0; i < WEEKDAYS.length; i++) {
        html += '<div class="weekday">' + WEEKDAYS[i] + '</div>';
      }
      weekdayRow.innerHTML = html;
    }

    function renderCalendar() {
      if (!calendarDays || !monthLabel) return;

      var year = currentMonth.getFullYear();
      var month = currentMonth.getMonth();
      monthLabel.textContent = MONTH_NAMES[month] + ' ' + year;

      var firstDay = new Date(year, month, 1);
      var startOffset = getWeekdayOffset(firstDay);
      var daysInMonth = new Date(year, month + 1, 0).getDate();

      var html = '';

      for (var i = 0; i < startOffset; i++) {
        html += '<div class="day-cell is-empty"></div>';
      }

      for (var day = 1; day <= daysInMonth; day++) {
        var date = new Date(year, month, day);
        var dateKey = getDateKey(date);
        var events = eventsByDate[dateKey] || [];

        var dots = '';
        var dotCount = Math.min(events.length, 6);
        for (var d = 0; d < dotCount; d++) {
          var statusClass = events[d].status || 'waiting';
          dots += '<span class="event-dot ' + statusClass + '"></span>';
        }

        var countLabel = '';
        if (events.length > 0) {
          countLabel = '<span class="event-count">' + events.length + ' event' + (events.length > 1 ? 's' : '') + '</span>';
        }

        var selectedClass = (selectedDateKey === dateKey) ? ' is-selected' : '';

        html += '<div class="day-cell' + selectedClass + '" data-date="' + dateKey + '">'
          + '<div class="day-number">' + day + '</div>'
          + '<div class="day-events">' + dots + '</div>'
          + countLabel
          + '</div>';
      }

      calendarDays.innerHTML = html;
    }

    function renderHistory(dateKey) {
      var events = eventsByDate[dateKey] || [];
      var formattedDate = dateKey ? dateKey.split('-').reverse().join('.') : '';
      historyTitle.textContent = dateKey ? 'Events on ' + formattedDate : 'Events';

      if (events.length === 0) {
        historyList.innerHTML = '<div class="empty-state">No submissions or decisions on this date.</div>';
        return;
      }

      var html = '';
      for (var i = 0; i < events.length; i++) {
        var event = events[i];
        var timeLabel = formatTime(event.date);
        var chipClass = event.status || 'waiting';
        var statusLabel = STATUS_LABELS[event.status] || STATUS_LABELS.waiting;

        var eventTitle;
        if (event.type === 'decision') {
          eventTitle = 'Decision: ' + statusLabel;
        } else {
          eventTitle = 'Submission';
        }

        var emailLine;
        if (event.type === 'decision') {
          emailLine = event.reviewerEmail ? 'Reviewed by ' + event.reviewerEmail : 'Reviewed by RGA';
        } else {
          emailLine = event.employeeEmail ? 'Submitted by ' + event.employeeEmail : 'Submitted by employee';
        }

        var noteLine = '';
        if (event.reviewNote) {
          noteLine = '<p>Note: ' + event.reviewNote + '</p>';
        }

        var fileLink = '';
        if (event.fileUrl) {
          fileLink = '<div class="history-actions">'
            + '<button type="button" data-action="download" data-fileurl="' + event.fileUrl + '" data-filename="' + (event.fileName || 'submission') + '">Download photo</button>'
            + '</div>';
        }

        html += '<div class="history-item">'
          + '<h3>' + event.taskTitle + '</h3>'
          + '<div class="history-meta">'
          + '<span class="history-chip ' + chipClass + '">' + statusLabel + '</span>'
          + '<span>' + eventTitle + '</span>'
          + '<span>' + timeLabel + '</span>'
          + '</div>'
          + '<p>' + event.pharmacyLabel + '</p>'
          + '<p>' + emailLine + '</p>'
          + noteLine
          + fileLink
          + '</div>';
      }

      historyList.innerHTML = html;
    }

    function updateSelectedDate(dateKey) {
      selectedDateKey = dateKey;
      renderCalendar();
      renderHistory(dateKey);
    }


    function setupCalendarInteractions() {
      calendarDays.addEventListener('click', function(e) {
        var cell = e.target.closest('.day-cell');
        if (!cell || cell.classList.contains('is-empty')) return;
        var dateKey = cell.dataset.date;
        updateSelectedDate(dateKey);
      });

      historyList.addEventListener('click', function(e) {
        var button = e.target.closest('button[data-action="download"]');
        if (!button) return;
        var fileUrl = button.dataset.fileurl;
        if (fileUrl) {
          window.open(fileUrl, '_blank');
        }
      });

      prevMonthBtn.addEventListener('click', function() {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
        renderCalendar();
      });

      nextMonthBtn.addEventListener('click', function() {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
        renderCalendar();
      });
    }


    function buildPharmacyFilter() {
      if (!pharmacyFilter) return;
      pharmacyFilter.innerHTML = '';

      if (pharmacies.length > 1) {
        var allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'All pharmacies';
        pharmacyFilter.appendChild(allOption);
      }

      for (var i = 0; i < pharmacies.length; i++) {
        var option = document.createElement('option');
        option.value = String(pharmacies[i].index);
        option.textContent = buildPharmacyLabel(pharmacies[i]);
        pharmacyFilter.appendChild(option);
      }

      if (pharmacies.length <= 1) {
        pharmacyFilter.disabled = true;
        filteredPharmacyIndex = pharmacies[0] ? String(pharmacies[0].index) : 'all';
        pharmacyFilter.value = filteredPharmacyIndex;
      } else {
        pharmacyFilter.disabled = false;
        filteredPharmacyIndex = 'all';
        pharmacyFilter.value = 'all';
      }
    }


    async function fetchSession() {
      try {
        var response = await fetch('/api/session');
        if (!response.ok) return null;
        var data = await response.json();
        if (data && data.session) return data.session;
        return null;
      } catch (error) {
        console.warn('Unable to load session', error);
        return null;
      }
    }

    async function fetchProfile() {
      try {
        var response = await fetch('/api/profile');
        if (!response.ok) return null;
        var data = await response.json();
        if (data && data.profile) return data.profile;
        return null;
      } catch (error) {
        console.warn('Unable to fetch profile', error);
        return null;
      }
    }

    async function fetchSubmissions(query) {
      var params = new URLSearchParams();
      var keys = Object.keys(query || {});
      for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        var value = query[key];
        if (value === undefined || value === null || value === '') continue;
        if (Array.isArray(value)) {
          params.append(key, value.join(','));
        } else {
          params.append(key, value);
        }
      }

      var response = await fetch('/api/get-submissions?' + params.toString());
      if (!response.ok) {
        var text = await response.text();
        throw new Error(text || 'Unable to fetch submissions');
      }
      var data = await response.json();
      if (!data || !data.ok) throw new Error('Unexpected response');
      return data.submissions || [];
    }

    async function fetchTaskDefinitions() {
      try {
        var response = await fetch('/api/task-definitions');
        if (!response.ok) return DEFAULT_TASK_DEFINITIONS;
        var data = await response.json();
        if (data && Array.isArray(data.tasks)) return data.tasks;
        return DEFAULT_TASK_DEFINITIONS;
      } catch (error) {
        console.warn('Unable to fetch task definitions', error);
        return DEFAULT_TASK_DEFINITIONS;
      }
    }

    function updateDashboardLink() {
      if (!dashboardLink) return;
      if ((role || '').toLowerCase() === 'rga') {
        dashboardLink.href = 'rga-dashboard.html';
      } else {
        dashboardLink.href = 'employee.html';
      }
    }


    async function init() {
      renderWeekdays();
      setupCalendarInteractions();

      var session = await fetchSession();
      if (!session) {
        window.location.href = 'register.html';
        return;
      }
      role = session.role || '';
      updateDashboardLink();

      var mainEl = document.getElementById('mainContent');
      if (mainEl) mainEl.style.display = '';

      var profile = await fetchProfile();
      if (!profile) {
        window.location.href = 'profile.html';
        return;
      }

      taskDefinitions = await fetchTaskDefinitions();
      taskTitles = buildTaskTitles(taskDefinitions);

      pharmacies = Array.isArray(profile.pharmacies) ? profile.pharmacies : [];
      if (pharmacies.length === 0) {
        subtitleEl.textContent = 'No pharmacies assigned yet. Please update your profile.';
        historyList.innerHTML = '<div class="empty-state">No pharmacy data available.</div>';
        calendarDays.innerHTML = '<div class="empty-state">No data to display.</div>';
        return;
      }

      pharmacyLookup = {};
      for (var i = 0; i < pharmacies.length; i++) {
        var pharmacy = pharmacies[i];
        if (pharmacy && pharmacy.index !== undefined && pharmacy.index !== null) {
          pharmacyLookup[String(pharmacy.index)] = buildPharmacyLabel(pharmacy);
        }
      }

      buildPharmacyFilter();

      var pharmacyIndexes = [];
      for (var i = 0; i < pharmacies.length; i++) {
        if (pharmacies[i].index !== undefined && pharmacies[i].index !== null) {
          pharmacyIndexes.push(pharmacies[i].index);
        }
      }

      try {
        submissions = await fetchSubmissions({ pharmacies: pharmacyIndexes });
      } catch (error) {
        console.warn('Unable to load submissions', error);
        subtitleEl.textContent = 'Unable to load history right now.';
        historyList.innerHTML = '<div class="empty-state">Please try again later.</div>';
      }

      refreshEvents();
      var todayKey = getDateKey(new Date());
      var dateKeys = Object.keys(eventsByDate).sort();
      if (eventsByDate[todayKey]) {
        selectedDateKey = todayKey;
      } else if (dateKeys.length > 0) {
        selectedDateKey = dateKeys[dateKeys.length - 1];
      } else {
        selectedDateKey = todayKey;
      }

      renderCalendar();
      renderHistory(selectedDateKey);

      pharmacyFilter.addEventListener('change', function() {
        filteredPharmacyIndex = pharmacyFilter.value;
        refreshEvents();

        var nextKey;
        if (eventsByDate[selectedDateKey]) {
          nextKey = selectedDateKey;
        } else {
          var keys = Object.keys(eventsByDate).sort();
          if (keys.length > 0) {
            nextKey = keys[keys.length - 1];
          } else {
            nextKey = getDateKey(new Date());
          }
        }
        updateSelectedDate(nextKey);
      });
    }

    init();
  </script>
  <script src="cookie-consent.js"></script>
</body>
</html>
